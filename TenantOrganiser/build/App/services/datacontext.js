define(["durandal/system","services/model","config","services/logger","services/helper"],function(e,n,t,r,a){function o(n){var t="Error retreiving data. "+n.message;r.logError(t,n,e.getModuleId(pn),!0)}function i(){var e=new breeze.EntityManager(t.remoteServiceName);return n.configureMetadataStore(e.metadataStore),e}function s(e){var n=e.message;return n.match(/validation error/i)?l(e):n}function l(e){try{return e.entityErrors.map(function(e){return e.errorMessage}).join("<br />")}catch(n){}return"validation error"}function c(n,t,a){r.log(n,t,e.getModuleId(pn),a)}function u(n,t,a){r.logSuccess(n,t,e.getModuleId(pn),a)}function d(n,t,a){r.logError(n,t,e.getModuleId(pn),a)}var p=breeze.EntityQuery,v=i(),f=!1,g=function(){return f?void 0:F().then(N).then(M).then(P).then(E).then(Y).then(H).then(B).then(function(){f=!0})},b=function(e){var n=$.Deferred();return $.ajax({type:"GET",dataType:"json",url:"account/usersession"}).success(function(t){return t?(T(t.Id,e).then(function(){n.resolve(e)}),void 0):(e(!1),n.resolve(!1),void 0)}).fail(function(e){d("There was a problem getting the logged in user.",e,!0),n.resolve(!1)}),n.promise()},m=function(e,n,t,r){return $.ajax({type:"POST",dataType:"json",url:"account/register",data:a.AddAntiForgeryToken({FirstName:e,LastName:n,Email:t,Password:r})})},h=function(e,n){return $.ajax({type:"POST",dataType:"json",url:"account/login",data:{Email:e,Password:n}})},y=function(){return $.ajax({type:"POST",url:"account/logoff",data:a.AddAntiForgeryToken({})})},w=function(e){return $.ajax({type:"POST",url:"account/changepassword",data:a.AddAntiForgeryToken({password:e})})},k=function(e,n,t){function r(r){if(r.results[0])return d("This house code already exists. Please choose a different one.",r,!0),void 0;var a=v.createEntity("House",{HouseName:n,HouseCode:t});return v.fetchEntityByKey("User",e().Id(),!0).then(function(e){var n=e.entity;n.House(a),v.saveChanges(),u("Created house!",r,!0)}).then(function(){C(e)})}var a=p.from("Houses").where("HouseCode","==",t);return v.executeQuery(a).then(r).fail(o)},C=function(e){var n=p.from("HouseJoinRequests").where("UserId","==",e().Id());return v.executeQuery(n).then(function(e){return $.each(e.results,function(e,n){n.entityAspect.setDeleted()}),v.saveChanges()})},x=function(e,n){function t(n){if(n.results[0]){var t=n.results[0];return v.createEntity("HouseJoinRequest",{UserId:e().Id(),HouseId:t.Id()}),v.saveChanges(),u("Created house join request.",n,!0),void 0}d("House code does not exist.",n,!0)}var r=p.from("Houses").where("HouseCode","==",n);return v.executeQuery(r).then(t).fail(o)},I=function(e,n){return C(e).then(function(){return e().House(n()),v.saveChanges()})},A=function(e){return e().HouseId(null),console.log(e()),v.saveChanges()},S=function(e){return e.entityAspect.setDeleted(),v.saveChanges()},U=function(e){return e.entityAspect.setDeleted(),v.saveChanges()},D=function(e){function n(n){n.results&&e(n.results)}var t=p.from("HouseJoinRequests").where("UserId","==",e().Id());return v.executeQuery(t).then(n).fail(o)},R=function(e,n){function t(e){var t=e.results[0];t?n(t):n(null),c("Retreived user's join request.",e,!0)}var r=p.from("HouseJoinRequests").where("UserId","==",e().Id());return v.executeQuery(r).then(t).fail(o)},T=function(e,n){function t(e){e.results&&n(e.results[0])}var r=p.from("Users").where("Id","==",e).expand("House").expand("UserSettings");return v.executeQuery(r).then(t).fail(o)},N=function(e){function n(n){e&&e(n.results),c("Retrieved [Users] from remote data source",n,!0)}var t=p.from("Users").expand("House").expand("UserSettings");return v.executeQuery(t).then(n).fail(o)},H=function(e){function n(n){e&&e(n.results),c("Retrieved [Bin Rotas] from remote data source",n,!0)}var t=p.from("BinRotas");return v.executeQuery(t).then(n).fail(o)},B=function(e){function n(n){e&&e(n.results),c("Retrieved [Cleaning Rotas] from remote data source",n,!0)}var t=p.from("CleaningRotas");return v.executeQuery(t).then(n).fail(o)},E=function(e){function n(n){e&&e(n.results),c("Retrieved [Messages] from remote data source",n,!0)}var t=p.from("Messages").expand("Conversation").expand("UserSent");return v.executeQuery(t).then(n).fail(o)},P=function(e){function n(n){e&&e(n.results),c("Retrieved [Conversation Users] from remote data source",n,!0)}var t=p.from("ConversationUsers").expand("User").expand("Conversation");return v.executeQuery(t).then(n).fail(o)},M=function(e){function n(n){e&&e(n.results),c("Retrieved [Conversations] from remote data source",n,!0)}var t=p.from("Conversations").expand("Messages").expand("ConversationUsers").orderByDesc("DateStarted");return v.executeQuery(t).then(n).fail(o)},F=function(e){function n(n){e&&e(n.results),c("Retrieved [Houses] from remote data source",n,!0)}var t=p.from("Houses");return v.executeQuery(t).then(n).fail(o)},O=function(e,n){function t(n){e(n.results),c("Retrieved [Bin Rotas] from remote data source",n,!0)}var r=p.from("BinRotas").where("HouseId","==",n);return v.executeQuery(r).then(t).fail(o)},_=function(e,n){function t(n){e(n.results),c("Retrieved [Cleaning Rotas] from remote data source",n,!0)}var r=p.from("CleaningRotas").where("HouseId","==",n);return v.executeQuery(r).then(t).fail(o)},j=function(e,n){function t(n){e(n.results),c("Retrieved [Announcements] from remote data source",n,!0)}var r=p.from("CommunalMessages").where("HouseId","==",n).orderByDesc("SentDate");return v.executeQuery(r).then(t).fail(o)},V=function(e,n){function t(n){e(n.results),c("Retrieved [Activity Logs] from remote data source",n,!0)}var r=p.from("ActivityLogs").where("HouseId","==",n).orderByDesc("Date");return v.executeQuery(r).then(t).fail(o)},L=function(e,n){function t(n){e(n.results),c("Retrieved [Wish List Items] from remote data source",n,!0)}var r=p.from("WishListItems").orderBy("AquiredOn").where("House.Id","==",n);return v.executeQuery(r).then(t).fail(o)},q=function(e,n){function t(n){e(n.results),c("Retrieved [House Join Requests] from remote data source",n,!0)}var r=p.from("HouseJoinRequests").where("HouseId","==",n);return v.executeQuery(r).then(t).fail(o)},Q=function(e,n){function t(n){e(n.results),c("Retrieved [Tenants] from remote data source",n,!0)}var r=p.from("Users").where("House.Id","==",n).expand("House").expand("UserSettings");return v.executeQuery(r).then(t).fail(o)},Y=function(){function e(e){c("Retrieved [Bills] from remote data source",e,!0)}var n=p.from("BillTypes").expand("Manager").expand("BillInvoices").expand("BillInvoices.Recipients");return v.executeQuery(n).then(e).fail(o)},W=function(e,n){return e(v.getEntityByKey("BillType",n))},J=function(e,n){return e(v.getEntityByKey("BillInvoice",n))},G=function(e,n){function t(n){e(n.results),c("Retrieved [Bills] from remote data source",n,!0)}var r=p.from("BillTypes").where("Manager.HouseId","==",n).expand("Manager").expand("BillInvoices").expand("BillInvoices.Recipients");return v.executeQuery(r).then(t).fail(o)},K=function(){return v.createEntity("CommunalMessage")},z=function(){return v.createEntity("WishListItem")},Z=function(){return v.createEntity("Message")},X=function(){return v.createEntity("Conversation")},en=function(e,n){return v.createEntity("ConversationUser",{Conversation:e,User:n})},nn=function(e){return v.createEntity("InvoiceRecipient",{BillInvoice:e})},tn=function(e){return v.createEntity("BillInvoice",{BillType:e})},rn=function(){return v.createEntity("BillType")},an=function(e){return v.createEntity("BinRota",{House:e})},on=function(e){return v.createEntity("CleaningRota",{House:e})},sn=function(e){var n=v.getEntityByKey("BillInvoice",e.Id());return $.each(n.Recipients(),function(e,n){n.entityAspect.setDeleted()}),n.entityAspect.setDeleted(),un()},ln=function(e,n){function t(n){e(n.results),c("Retrieved [Conversations] from remote data source",n,!0)}var r=p.from("Conversations").where("ConversationUsers",breeze.FilterQueryOp.Any,"User.HouseId","==",n).orderByDesc("DateStarted");return v.executeQuery(r).then(t).fail(o)},cn=function(){return v.rejectChanges()},un=function(){function n(n){r.log("Changes Saved.",n,e.getModuleId(pn),!0)}function t(e){var n="Saved Failed: <br />"+s(e);throw d(n,e,!0),e.message=n,e}return v.saveChanges().then(n).fail(t)},dn=ko.observable(!1);v.hasChangesChanged.subscribe(function(e){dn(e.hasChanges)});var pn={saveChanges:un,rejectChanges:cn,hasChanges:dn,getUsers:N,getHouses:F,getAllBillTypes:Y,getBillTypesByHouse:G,getUserById:T,getTenants:Q,getPendingRequests:q,getJoinRequestsByUser:D,getBillTypeById:W,getInvoiceById:J,getBinRotasByHouse:O,getCleaningRotasByHouse:_,getConversations:M,getConversationsByHouse:ln,getAnnouncements:j,createAnnouncement:K,getWishListItems:L,createWishListItem:z,getActivitiyLogs:V,leaveHouse:A,primeData:g,getLoggedInUser:b,login:h,logout:y,register:m,changePassword:w,joinHouse:x,joinTenantToHouse:I,createHouse:k,createMessage:Z,createConversationUser:en,createConversation:X,createBillInvoice:tn,createInvoiceRecipient:nn,createBillType:rn,createBinRota:an,createCleaningRota:on,getUsersJoinRequest:R,cancelHouseRequest:S,deleteCommunalMessage:U,deleteInvoice:sn};return pn});