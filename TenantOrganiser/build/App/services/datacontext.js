define(["durandal/system","services/model","config","services/logger","services/helper"],function(e,t,n,r,i){function o(t){var n="Error retreiving data. "+t.message;r.logError(n,t,e.getModuleId(mt),!0)}function a(){var e=new breeze.EntityManager(n.remoteServiceName);return t.configureMetadataStore(e.metadataStore),e}function s(e){var t=e.message;return t.match(/validation error/i)?l(e):t}function l(e){try{return e.entityErrors.map(function(e){return e.errorMessage}).join("<br />")}catch(t){}return"validation error"}function c(){}function u(){}function d(t,n,i){r.logError(t,n,e.getModuleId(mt),i)}var p=breeze.EntityQuery,f=a(),h=!1,g=function(){return h?void 0:q().then(F).then(j).then(H).then(L).then(Y).then(M).then(O).then(function(){h=!0})},v=function(e){var t=$.Deferred();return $.ajax({type:"GET",dataType:"json",url:"account/usersession"}).success(function(n){return n?(B(n.Id,e).then(function(){t.resolve(e)}),void 0):(e(!1),t.resolve(!1),void 0)}).fail(function(e){d("There was a problem getting the logged in user.",e,!0),t.resolve(!1)}),t.promise()},m=function(e,t,n,r){return $.ajax({type:"POST",dataType:"json",url:"account/register",data:i.AddAntiForgeryToken({FirstName:e,LastName:t,Email:n,Password:r})})},b=function(e,t){return $.ajax({type:"POST",dataType:"json",url:"account/login",data:{Email:e,Password:t}})},y=function(e){return $.ajax({type:"POST",dataType:"json",url:"account/facebooklogin",data:{token:e}})},_=function(){return $.ajax({type:"POST",url:"account/logoff",data:i.AddAntiForgeryToken({})})},w=function(e){return $.ajax({type:"POST",url:"account/changepassword",data:i.AddAntiForgeryToken({password:e})})},k=function(e){return $.ajax({type:"POST",url:"account/changeemail",data:{newEmail:e}})},x=function(e){return $.ajax({type:"POST",url:"account/uploadfacebookpicture",data:{username:e}})},C=function(e){return $.ajax({type:"POST",url:"account/uploadurlpicture",data:{url:e}})},I=function(e){return $.ajax({type:"POST",url:"account/uploadfilepicture",data:e,cache:!1,contentType:!1,processData:!1})},A=function(e,t,n){function r(r){if(r.results[0])return d("This house code already exists. Please choose a different one.",r,!0),void 0;var i=f.createEntity("House",{HouseName:t,HouseCode:n});return f.fetchEntityByKey("User",e().Id(),!0).then(function(e){var t=e.entity;t.House(i),f.saveChanges(),u("Created house!",r,!0)}).then(function(){S(e)})}var i=p.from("Houses").where("HouseCode","==",n);return f.executeQuery(i).then(r).fail(o)},S=function(e){var t=p.from("HouseJoinRequests").where("UserId","==",e().Id());return f.executeQuery(t).then(function(e){return $.each(e.results,function(e,t){t.entityAspect.setDeleted()}),f.saveChanges()})},R=function(e,t){function n(t){if(t.results[0]){var n=t.results[0];return f.createEntity("HouseJoinRequest",{UserId:e().Id(),HouseId:n.Id()}),f.saveChanges().then(function(){u("Created house join request.",t,!0)})}d("House code does not exist.",t,!0)}var r=p.from("Houses").where("HouseCode","==",t);return f.executeQuery(r).then(n).fail(o)},E=function(e,t){e().HouseId(t().Id());var n=p.from("HouseJoinRequests").where("UserId","==",e().Id());return f.executeQuery(n).then(function(e){return $.each(e.results,function(e,t){t.entityAspect.setDeleted()}),f.saveChanges()})},N=function(e){return e().HouseId(null),console.log(e()),f.saveChanges()},T=function(e){return e.entityAspect.setDeleted(),f.saveChanges()},D=function(e){return e.entityAspect.setDeleted(),f.saveChanges()},U=function(e){function t(t){t.results&&e(t.results)}var n=p.from("HouseJoinRequests").where("UserId","==",e().Id());return f.executeQuery(n).then(t).fail(o)},P=function(e,t){function n(e){var n=e.results[0];n?t(n):t(null),c("Retreived user's join request.",e,!0)}var r=p.from("HouseJoinRequests").where("UserId","==",e().Id());return f.executeQuery(r).then(n).fail(o)},B=function(e,t){function n(e){e.results&&t(e.results[0])}var r=p.from("Users").where("Id","==",e).expand("House").expand("UserSettings");return f.executeQuery(r).then(n).fail(o)},F=function(e){function t(t){e&&e(t.results),c("Retrieved [Users] from remote data source",t,!0)}var n=p.from("Users").expand("House").expand("UserSettings");return f.executeQuery(n).then(t).fail(o)},M=function(e){function t(t){e&&e(t.results),c("Retrieved [Bin Rotas] from remote data source",t,!0)}var n=p.from("BinRotas");return f.executeQuery(n).then(t).fail(o)},O=function(e){function t(t){e&&e(t.results),c("Retrieved [Cleaning Rotas] from remote data source",t,!0)}var n=p.from("CleaningRotas").expand("CleaningLogs");return f.executeQuery(n).then(t).fail(o)},L=function(e){function t(t){e&&e(t.results),c("Retrieved [Messages] from remote data source",t,!0)}var n=p.from("Messages").expand("Conversation").expand("UserSent");return f.executeQuery(n).then(t).fail(o)},H=function(e){function t(t){e&&e(t.results),c("Retrieved [Conversation Users] from remote data source",t,!0)}var n=p.from("ConversationUsers").expand("User").expand("Conversation");return f.executeQuery(n).then(t).fail(o)},j=function(e){function t(t){e&&e(t.results),c("Retrieved [Conversations] from remote data source",t,!0)}var n=p.from("Conversations").expand("Messages").expand("ConversationUsers").orderByDesc("DateStarted");return f.executeQuery(n).then(t).fail(o)},q=function(e){function t(t){e&&e(t.results),c("Retrieved [Houses] from remote data source",t,!0)}var n=p.from("Houses");return f.executeQuery(n).then(t).fail(o)},V=function(e,t){function n(t){e(t.results),c("Retrieved [Bin Rotas] from remote data source",t,!0)}var r=p.from("BinRotas").where("HouseId","==",t);return f.executeQuery(r).then(n).fail(o)},z=function(e,t){function n(t){e(t.results),c("Retrieved [Cleaning Rotas] from remote data source",t,!0)}var r=p.from("CleaningRotas").where("HouseId","==",t);return f.executeQuery(r).then(n).fail(o)},W=function(e,t){function n(t){e(t.results),c("Retrieved [Announcements] from remote data source",t,!0)}var r=p.from("CommunalMessages").where("HouseId","==",t).orderByDesc("SentDate");return f.executeQuery(r).then(n).fail(o)},Q=function(e,t){function n(t){e(t.results),c("Retrieved [Activity Logs] from remote data source",t,!0)}var r=p.from("ActivityLogs").where("HouseId","==",t).orderByDesc("Date");return f.executeQuery(r).then(n).fail(o)},J=function(e,t){function n(t){e(t.results),c("Retrieved [Wish List Items] from remote data source",t,!0)}var r=p.from("WishListItems").orderBy("AquiredOn").where("House.Id","==",t);return f.executeQuery(r).then(n).fail(o)},X=function(e,t){function n(t){e(t.results),c("Retrieved [House Join Requests] from remote data source",t,!0)}var r=p.from("HouseJoinRequests").where("HouseId","==",t).expand("User").expand("House");return f.executeQuery(r).then(n).fail(o)},G=function(e,t){function n(t){e(t.results),c("Retrieved [Tenants] from remote data source",t,!0)}var r=p.from("Users").where("House.Id","==",t).expand("House").expand("UserSettings");return f.executeQuery(r).then(n).fail(o)},Y=function(){function e(e){c("Retrieved [Bills] from remote data source",e,!0)}var t=p.from("BillTypes").expand("Manager").expand("BillInvoices").expand("BillInvoices.Recipients");return f.executeQuery(t).then(e).fail(o)},K=function(e,t){return e(f.getEntityByKey("BillType",t))},Z=function(e,t){return e(f.getEntityByKey("BillInvoice",t))},et=function(e,t){function n(t){e(t.results),c("Retrieved [Bills] from remote data source",t,!0)}var r=p.from("BillTypes").where("Manager.HouseId","==",t).expand("Manager").expand("BillInvoices").expand("BillInvoices.Recipients");return f.executeQuery(r).then(n).fail(o)},tt=function(){return f.createEntity("CommunalMessage")},nt=function(){return f.createEntity("WishListItem")},rt=function(){return f.createEntity("Message")},it=function(){return f.createEntity("Conversation")},ot=function(e,t){return f.createEntity("ConversationUser",{Conversation:e,User:t})},at=function(e){return f.createEntity("InvoiceRecipient",{BillInvoice:e})},st=function(e){return f.createEntity("BillInvoice",{BillType:e})},lt=function(){return f.createEntity("BillType")},ct=function(e){return f.createEntity("BinRota",{House:e})},ut=function(e){return f.createEntity("CleaningRota",{House:e})},dt=function(){return f.createEntity("CleaningLog")},pt=function(e){var t=f.getEntityByKey("BillInvoice",e.Id());return $.each(t.Recipients(),function(e,t){t.entityAspect.setDeleted()}),t.entityAspect.setDeleted(),gt()},ft=function(e,t){function n(t){e(t.results),c("Retrieved [Conversations] from remote data source",t,!0)}var r=p.from("Conversations").where("ConversationUsers",breeze.FilterQueryOp.Any,"User.HouseId","==",t).orderByDesc("DateStarted");return f.executeQuery(r).then(n).fail(o)},ht=function(){return f.rejectChanges()},gt=function(){function t(t){r.log("Changes Saved.",t,e.getModuleId(mt),!0)}function n(e){var t="Saved Failed: <br />"+s(e);throw d(t,e,!0),e.message=t,e}return f.saveChanges().then(t).fail(n)},vt=ko.observable(!1);f.hasChangesChanged.subscribe(function(e){vt(e.hasChanges)});var mt={saveChanges:gt,rejectChanges:ht,hasChanges:vt,getUsers:F,getHouses:q,getAllBillTypes:Y,getBillTypesByHouse:et,getUserById:B,getTenants:G,getPendingRequests:X,getJoinRequestsByUser:U,getBillTypeById:K,getInvoiceById:Z,getBinRotasByHouse:V,getCleaningRotasByHouse:z,getConversations:j,getConversationsByHouse:ft,getAnnouncements:W,createAnnouncement:tt,getWishListItems:J,createWishListItem:nt,getActivitiyLogs:Q,leaveHouse:N,primeData:g,getLoggedInUser:v,login:b,facebookLogin:y,logout:_,register:m,changePassword:w,changeEmail:k,joinHouse:R,joinTenantToHouse:E,createHouse:A,createMessage:rt,createConversationUser:ot,createConversation:it,createBillInvoice:st,createInvoiceRecipient:at,createBillType:lt,createBinRota:ct,createCleaningRota:ut,createCleaningRotaLog:dt,getUsersJoinRequest:P,cancelHouseRequest:T,deleteCommunalMessage:D,deleteInvoice:pt,uploadFacebookPicture:x,uploadUrlPicture:C,uploadFilePicture:I};return mt});