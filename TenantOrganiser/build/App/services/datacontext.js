define(["durandal/system","services/model","config","services/logger","services/helper"],function(e,t,n,r,i){function o(t){var n="Error retreiving data. "+t.message;r.logError(n,t,e.getModuleId(pt),!0)}function a(){var e=new breeze.EntityManager(n.remoteServiceName);return t.configureMetadataStore(e.metadataStore),e}function s(e){var t=e.message;return t.match(/validation error/i)?l(e):t}function l(e){try{return e.entityErrors.map(function(e){return e.errorMessage}).join("<br />")}catch(t){}return"validation error"}function c(t,n,i){r.log(t,n,e.getModuleId(pt),i)}function u(t,n,i){r.logSuccess(t,n,e.getModuleId(pt),i)}function d(t,n,i){r.logError(t,n,e.getModuleId(pt),i)}var p=breeze.EntityQuery,f=a(),h=!1,g=function(){return h?void 0:O().then(D).then(M).then(F).then(P).then(Q).then(U).then(B).then(function(){h=!0})},m=function(e){var t=$.Deferred();return $.ajax({type:"GET",dataType:"json",url:"account/usersession"}).success(function(n){return n?(T(n.Id,e).then(function(){t.resolve(e)}),void 0):(e(!1),t.resolve(!1),void 0)}).fail(function(e){d("There was a problem getting the logged in user.",e,!0),t.resolve(!1)}),t.promise()},v=function(e,t,n,r){return $.ajax({type:"POST",dataType:"json",url:"account/register",data:i.AddAntiForgeryToken({FirstName:e,LastName:t,Email:n,Password:r})})},b=function(e,t){return $.ajax({type:"POST",dataType:"json",url:"account/login",data:{Email:e,Password:t}})},y=function(e){return $.ajax({type:"POST",dataType:"json",url:"account/facebooklogin",data:{token:e}})},_=function(){return $.ajax({type:"POST",url:"account/logoff",data:i.AddAntiForgeryToken({})})},w=function(e){return $.ajax({type:"POST",url:"account/changepassword",data:i.AddAntiForgeryToken({password:e})})},k=function(e,t,n){function r(r){if(r.results[0])return d("This house code already exists. Please choose a different one.",r,!0),void 0;var i=f.createEntity("House",{HouseName:t,HouseCode:n});return f.fetchEntityByKey("User",e().Id(),!0).then(function(e){var t=e.entity;t.House(i),f.saveChanges(),u("Created house!",r,!0)}).then(function(){x(e)})}var i=p.from("Houses").where("HouseCode","==",n);return f.executeQuery(i).then(r).fail(o)},x=function(e){var t=p.from("HouseJoinRequests").where("UserId","==",e().Id());return f.executeQuery(t).then(function(e){return $.each(e.results,function(e,t){t.entityAspect.setDeleted()}),f.saveChanges()})},C=function(e,t){function n(t){if(t.results[0]){var n=t.results[0];return f.createEntity("HouseJoinRequest",{UserId:e().Id(),HouseId:n.Id()}),f.saveChanges(),u("Created house join request.",t,!0),void 0}d("House code does not exist.",t,!0)}var r=p.from("Houses").where("HouseCode","==",t);return f.executeQuery(r).then(n).fail(o)},I=function(e,t){return x(e).then(function(){return e().House(t()),f.saveChanges()})},A=function(e){return e().HouseId(null),console.log(e()),f.saveChanges()},S=function(e){return e.entityAspect.setDeleted(),f.saveChanges()},R=function(e){return e.entityAspect.setDeleted(),f.saveChanges()},E=function(e){function t(t){t.results&&e(t.results)}var n=p.from("HouseJoinRequests").where("UserId","==",e().Id());return f.executeQuery(n).then(t).fail(o)},N=function(e,t){function n(e){var n=e.results[0];n?t(n):t(null),c("Retreived user's join request.",e,!0)}var r=p.from("HouseJoinRequests").where("UserId","==",e().Id());return f.executeQuery(r).then(n).fail(o)},T=function(e,t){function n(e){e.results&&t(e.results[0])}var r=p.from("Users").where("Id","==",e).expand("House").expand("UserSettings");return f.executeQuery(r).then(n).fail(o)},D=function(e){function t(t){e&&e(t.results),c("Retrieved [Users] from remote data source",t,!0)}var n=p.from("Users").expand("House").expand("UserSettings");return f.executeQuery(n).then(t).fail(o)},U=function(e){function t(t){e&&e(t.results),c("Retrieved [Bin Rotas] from remote data source",t,!0)}var n=p.from("BinRotas");return f.executeQuery(n).then(t).fail(o)},B=function(e){function t(t){e&&e(t.results),c("Retrieved [Cleaning Rotas] from remote data source",t,!0)}var n=p.from("CleaningRotas");return f.executeQuery(n).then(t).fail(o)},P=function(e){function t(t){e&&e(t.results),c("Retrieved [Messages] from remote data source",t,!0)}var n=p.from("Messages").expand("Conversation").expand("UserSent");return f.executeQuery(n).then(t).fail(o)},F=function(e){function t(t){e&&e(t.results),c("Retrieved [Conversation Users] from remote data source",t,!0)}var n=p.from("ConversationUsers").expand("User").expand("Conversation");return f.executeQuery(n).then(t).fail(o)},M=function(e){function t(t){e&&e(t.results),c("Retrieved [Conversations] from remote data source",t,!0)}var n=p.from("Conversations").expand("Messages").expand("ConversationUsers").orderByDesc("DateStarted");return f.executeQuery(n).then(t).fail(o)},O=function(e){function t(t){e&&e(t.results),c("Retrieved [Houses] from remote data source",t,!0)}var n=p.from("Houses");return f.executeQuery(n).then(t).fail(o)},L=function(e,t){function n(t){e(t.results),c("Retrieved [Bin Rotas] from remote data source",t,!0)}var r=p.from("BinRotas").where("HouseId","==",t);return f.executeQuery(r).then(n).fail(o)},H=function(e,t){function n(t){e(t.results),c("Retrieved [Cleaning Rotas] from remote data source",t,!0)}var r=p.from("CleaningRotas").where("HouseId","==",t);return f.executeQuery(r).then(n).fail(o)},j=function(e,t){function n(t){e(t.results),c("Retrieved [Announcements] from remote data source",t,!0)}var r=p.from("CommunalMessages").where("HouseId","==",t).orderByDesc("SentDate");return f.executeQuery(r).then(n).fail(o)},q=function(e,t){function n(t){e(t.results),c("Retrieved [Activity Logs] from remote data source",t,!0)}var r=p.from("ActivityLogs").where("HouseId","==",t).orderByDesc("Date");return f.executeQuery(r).then(n).fail(o)},V=function(e,t){function n(t){e(t.results),c("Retrieved [Wish List Items] from remote data source",t,!0)}var r=p.from("WishListItems").orderBy("AquiredOn").where("House.Id","==",t);return f.executeQuery(r).then(n).fail(o)},z=function(e,t){function n(t){e(t.results),c("Retrieved [House Join Requests] from remote data source",t,!0)}var r=p.from("HouseJoinRequests").where("HouseId","==",t);return f.executeQuery(r).then(n).fail(o)},W=function(e,t){function n(t){e(t.results),c("Retrieved [Tenants] from remote data source",t,!0)}var r=p.from("Users").where("House.Id","==",t).expand("House").expand("UserSettings");return f.executeQuery(r).then(n).fail(o)},Q=function(){function e(e){c("Retrieved [Bills] from remote data source",e,!0)}var t=p.from("BillTypes").expand("Manager").expand("BillInvoices").expand("BillInvoices.Recipients");return f.executeQuery(t).then(e).fail(o)},J=function(e,t){return e(f.getEntityByKey("BillType",t))},X=function(e,t){return e(f.getEntityByKey("BillInvoice",t))},Y=function(e,t){function n(t){e(t.results),c("Retrieved [Bills] from remote data source",t,!0)}var r=p.from("BillTypes").where("Manager.HouseId","==",t).expand("Manager").expand("BillInvoices").expand("BillInvoices.Recipients");return f.executeQuery(r).then(n).fail(o)},G=function(){return f.createEntity("CommunalMessage")},K=function(){return f.createEntity("WishListItem")},Z=function(){return f.createEntity("Message")},et=function(){return f.createEntity("Conversation")},tt=function(e,t){return f.createEntity("ConversationUser",{Conversation:e,User:t})},nt=function(e){return f.createEntity("InvoiceRecipient",{BillInvoice:e})},rt=function(e){return f.createEntity("BillInvoice",{BillType:e})},it=function(){return f.createEntity("BillType")},ot=function(e){return f.createEntity("BinRota",{House:e})},at=function(e){return f.createEntity("CleaningRota",{House:e})},st=function(e){var t=f.getEntityByKey("BillInvoice",e.Id());return $.each(t.Recipients(),function(e,t){t.entityAspect.setDeleted()}),t.entityAspect.setDeleted(),ut()},lt=function(e,t){function n(t){e(t.results),c("Retrieved [Conversations] from remote data source",t,!0)}var r=p.from("Conversations").where("ConversationUsers",breeze.FilterQueryOp.Any,"User.HouseId","==",t).orderByDesc("DateStarted");return f.executeQuery(r).then(n).fail(o)},ct=function(){return f.rejectChanges()},ut=function(){function t(t){r.log("Changes Saved.",t,e.getModuleId(pt),!0)}function n(e){var t="Saved Failed: <br />"+s(e);throw d(t,e,!0),e.message=t,e}return f.saveChanges().then(t).fail(n)},dt=ko.observable(!1);f.hasChangesChanged.subscribe(function(e){dt(e.hasChanges)});var pt={saveChanges:ut,rejectChanges:ct,hasChanges:dt,getUsers:D,getHouses:O,getAllBillTypes:Q,getBillTypesByHouse:Y,getUserById:T,getTenants:W,getPendingRequests:z,getJoinRequestsByUser:E,getBillTypeById:J,getInvoiceById:X,getBinRotasByHouse:L,getCleaningRotasByHouse:H,getConversations:M,getConversationsByHouse:lt,getAnnouncements:j,createAnnouncement:G,getWishListItems:V,createWishListItem:K,getActivitiyLogs:q,leaveHouse:A,primeData:g,getLoggedInUser:m,login:b,facebookLogin:y,logout:_,register:v,changePassword:w,joinHouse:C,joinTenantToHouse:I,createHouse:k,createMessage:Z,createConversationUser:tt,createConversation:et,createBillInvoice:rt,createInvoiceRecipient:nt,createBillType:it,createBinRota:ot,createCleaningRota:at,getUsersJoinRequest:N,cancelHouseRequest:S,deleteCommunalMessage:R,deleteInvoice:st};return pt});