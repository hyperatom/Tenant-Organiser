define(["durandal/system","services/model","config","services/logger","services/helper"],function(e,n,t,r,a){function o(n){var t="Error retreiving data. "+n.message;r.logError(t,n,e.getModuleId(z),!0)}function i(){var e=new breeze.EntityManager(t.remoteServiceName);return n.configureMetadataStore(e.metadataStore),e}function s(e){var n=e.message;return n.match(/validation error/i)?l(e):n}function l(e){try{return e.entitiesWithErrors.map(function(e){return e.entityAspect.getValidationErrors().map(function(e){return e.errorMessage}).join("<br />")}).join("<br />")}catch(n){}return"validation error"}function c(n,t,a){r.log(n,t,e.getModuleId(z),a)}function u(n,t,a){r.logSuccess(n,t,e.getModuleId(z),a)}function d(n,t,a){r.logError(n,t,e.getModuleId(z),a)}var p=breeze.EntityQuery,v=i(),b=!1,g=function(){return b?void 0:Q.all([P(),H(),M(),E(),D()]).then(function(){b=!0})},f=function(e){var n=$.Deferred();return $.ajax({type:"GET",dataType:"json",url:"account/usersession"}).success(function(t){return t?(R(t.Id,e).then(function(){n.resolve(e)}),void 0):(e(!1),n.resolve(!1),void 0)}).fail(function(e){d("There was a problem getting the logged in user.",e,!0),n.resolve(!1)}),n.promise()},m=function(e,n,t,r){return $.ajax({type:"POST",dataType:"json",url:"account/register",data:a.AddAntiForgeryToken({FirstName:e,LastName:n,Email:t,Password:r})})},h=function(e,n){return $.ajax({type:"POST",dataType:"json",url:"account/login",data:{Email:e,Password:n}})},y=function(){return $.ajax({type:"POST",url:"account/logoff",data:a.AddAntiForgeryToken({})})},w=function(e){return $.ajax({type:"POST",url:"account/changepassword",data:a.AddAntiForgeryToken({password:e})})},k=function(e,n,t){function r(r){if(r.results[0])return d("This house code already exists. Please choose a different one.",r,!0),void 0;var a=v.createEntity("House",{HouseName:n,HouseCode:t});return v.fetchEntityByKey("User",e().Id(),!0).then(function(e){var n=e.entity;n.House(a),v.saveChanges(),u("Created house!",r,!0)}).then(function(){C(e)})}var a=p.from("Houses").where("HouseCode","==",t);return v.executeQuery(a).then(r).fail(o)},C=function(e){var n=p.from("HouseJoinRequests").where("UserId","==",e().Id());return v.executeQuery(n).then(function(e){return $.each(e.results,function(e,n){n.entityAspect.setDeleted()}),v.saveChanges()})},x=function(e,n){function t(n){if(n.results[0]){var t=n.results[0];return v.createEntity("HouseJoinRequest",{UserId:e().Id(),HouseId:t.Id()}),v.saveChanges(),u("Created house join request.",n,!0),void 0}d("House code does not exist.",n,!0)}var r=p.from("Houses").where("HouseCode","==",n);return v.executeQuery(r).then(t).fail(o)},A=function(e,n){return C(e).then(function(){return e().House(n()),v.saveChanges()})},I=function(e){return e().HouseId(null),console.log(e()),v.saveChanges()},N=function(e){return e.entityAspect.setDeleted(),v.saveChanges()},S=function(e){return e.entityAspect.setDeleted(),v.saveChanges()},U=function(e){function n(n){n.results&&e(n.results)}var t=p.from("HouseJoinRequests").where("UserId","==",e().Id());return v.executeQuery(t).then(n).fail(o)},T=function(e,n){function t(e){var t=e.results[0];t?n(t):n(null),c("Retreived user's join request.",e,!0)}var r=p.from("HouseJoinRequests").where("UserId","==",e().Id());return v.executeQuery(r).then(t).fail(o)},R=function(e,n){function t(e){e.results&&n(e.results[0])}var r=p.from("Users").where("Id","==",e).expand("House").expand("UserSettings");return v.executeQuery(r).then(t).fail(o)},H=function(e){function n(n){e&&e(n.results),c("Retrieved [Users] from remote data source",n,!0)}var t=p.from("Users").expand("House").expand("UserSettings");return v.executeQuery(t).then(n).fail(o)},D=function(e){function n(n){e&&e(n.results),c("Retrieved [Messages] from remote data source",n,!0)}var t=p.from("Messages").expand("Conversation").expand("UserSent");return v.executeQuery(t).then(n).fail(o)},E=function(e){function n(n){e&&e(n.results),c("Retrieved [Conversation Users] from remote data source",n,!0)}var t=p.from("ConversationUsers").expand("User").expand("Conversation");return v.executeQuery(t).then(n).fail(o)},M=function(e){function n(n){e&&e(n.results),c("Retrieved [Conversations] from remote data source",n,!0)}var t=p.from("Conversations").expand("Messages").expand("ConversationUsers");return v.executeQuery(t).then(n).fail(o)},P=function(e){function n(n){e&&e(n.results),c("Retrieved [Houses] from remote data source",n,!0)}var t=p.from("Houses");return v.executeQuery(t).then(n).fail(o)},F=function(e,n){function t(n){e(n.results),c("Retrieved [Announcements] from remote data source",n,!0)}var r=p.from("CommunalMessages").where("HouseId","==",n).orderByDesc("SentDate");return v.executeQuery(r).then(t).fail(o)},B=function(e,n){function t(n){e(n.results),c("Retrieved [Activity Logs] from remote data source",n,!0)}var r=p.from("ActivityLogs").where("HouseId","==",n).orderByDesc("Date");return v.executeQuery(r).then(t).fail(o)},j=function(e,n){function t(n){e(n.results),c("Retrieved [Wish List Items] from remote data source",n,!0)}var r=p.from("WishListItems").orderBy("AquiredOn").where("House.Id","==",n);return v.executeQuery(r).then(t).fail(o)},O=function(e,n){function t(n){e(n.results),c("Retrieved [House Join Requests] from remote data source",n,!0)}var r=p.from("HouseJoinRequests").where("HouseId","==",n);return v.executeQuery(r).then(t).fail(o)},_=function(e,n){function t(n){e(n.results),c("Retrieved [Tenants] from remote data source",n,!0)}var r=p.from("Users").where("House.Id","==",n).expand("House");return v.executeQuery(r).then(t).fail(o)},V=function(){return v.createEntity("CommunalMessage")},L=function(){return v.createEntity("WishListItem")},q=function(){return v.createEntity("Message")},G=function(e,n){return v.createEntity("ConversationUser",{Conversation:e,User:n})},W=function(){return v.rejectChanges()},J=function(){function n(n){r.log("Changes Saved.",n,e.getModuleId(z),!0)}function t(e){var n="Saved Failed: <br />"+s(e);throw d(n,e,!0),e.message=n,e}return v.saveChanges().then(n).fail(t)},K=ko.observable(!1);v.hasChangesChanged.subscribe(function(e){K(e.hasChanges)});var z={saveChanges:J,rejectChanges:W,hasChanges:K,getUsers:H,getHouses:P,getUserById:R,getTenants:_,getPendingRequests:O,getJoinRequestsByUser:U,getConversations:M,getAnnouncements:F,createAnnouncement:V,getWishListItems:j,createWishListItem:L,getActivitiyLogs:B,leaveHouse:I,primeData:g,getLoggedInUser:f,login:h,logout:y,register:m,changePassword:w,joinHouse:x,joinTenantToHouse:A,createHouse:k,createMessage:q,createConversationUser:G,getUsersJoinRequest:T,cancelHouseRequest:N,deleteCommunalMessage:S};return z});