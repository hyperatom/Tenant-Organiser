define(["services/logger","plugins/router","services/datacontext","services/session"],function(e,n,t,r){function o(n){return Q.all([i(),s(n),l(),c()]).then(function(){y("New "+w().Name()+" Invoice"),e.log("Add Bill Invoice Activated",null,"add-bill-invoice",!0)})}function a(){w(null),U(null),C([]),S(null)}function i(){return t.getTenants(A,r.sessionUser().HouseId())}function s(e){return t.getBillTypeById(w,e)}function l(){return k({BillType:w(),Recipients:ko.observableArray()})}function c(){x({User:ko.observable({FullName:ko.observable("Select a recipient")}),BillInvoice:k(),Paid:ko.observable(!1),Amount:ko.observable()})}function u(){ko.observable.fn.beforeAndAfterSubscribe=function(e,n){var t;n.subscribe(function(e){t=e},null,"beforeChange"),n.subscribe(function(r){e(n,t,r)})},$(".input-group.date").datepicker({autoclose:!0,todayHighlight:!0}),ko.observable.fn.beforeAndAfterSubscribe(f,U)}function d(){function r(){return $.each(C(),function(e,n){var r=t.createInvoiceRecipient(o);r.Amount(n.Amount()),r.Paid(n.Paid()),r.User(n.User())}),t.saveChanges().then(function(){return e.logSuccess("Invoice Created!",null,"add-bill-invoice",!0),n.navigate("#bills")})}if(!S())return e.logError("Please enter a due date for the invoice.",null,"add-bill-invoice",!0),void 0;var o=t.createBillInvoice(w());return o.DueDate(moment(S(),"DD/MM/YYYY").format("MM/DD/YYYY")),t.saveChanges().then(r)}function p(){ko.utils.arrayForEach(C(),function(){C.removeAll()}),U(0),S(""),e.log("Changes undone!",null,"add-bill-invoice",!0)}function v(){D=!0;var e=0;ko.utils.arrayForEach(C(),function(n){console.log(e+=parseInt(n.Amount()))}),0==N&&U(e),D=!1}function f(e,n,t){var r=C().length;if(n!=t&&""!=t&&r>0&&0==D){var o=t/r;N=!0,ko.utils.arrayForEach(C(),function(e){e.Amount(o)}),N=!1}}function g(n){return n.Amount()?"Select a recipient"===n.User().FullName()?(e.logError("Please choose a recipient from the combo box.",null,"add-bill-invoice",!0),void 0):(n.Amount.subscribe(v),C.push(n),n.Amount.notifySubscribers(),c(),void 0):(e.logError("Please enter a bill amount for the new recipient.",null,"add-bill-invoice",!0),void 0)}function b(e){C.remove(e),e.Amount.notifySubscribers()}function m(e,n){n.User(e)}function h(n){n.Paid()?(n.Paid(!1),e.logSuccess(n.User().FullName().concat(" has now un-paid."),null,"add-bill-invoice",!0)):(n.Paid(!0),e.logSuccess(n.User().FullName().concat(" has now paid."),null,"add-bill-invoice",!0))}var y=new ko.observable,w=new ko.observable,k=new ko.observable,C=new ko.observableArray,x=new ko.observableArray,I=new ko.observable(!1),A=new ko.observableArray,U=new ko.observable(0),S=new ko.observable,D=!1,N=!1,T={activate:o,deactivate:a,title:"Add Bill Invoice View",attached:u,billType:w,billInvoice:k,pageHeader:y,clickedCombo:m,checkboxClicked:h,invoiceRecipients:C,newInvoiceRecipient:x,totalAmount:U,dueDate:S,addNewRecipient:g,removeRecipient:b,invoiceCreated:d,invoiceUndone:p,tenantsList:A,isUndoEnabled:I};return T});