define(["services/logger","plugins/router","services/datacontext","services/session"],function(e,t,n,r){function i(t){return Q.all([s(),l(t),c(),u()]).then(function(){_("New "+w().Name()+" Invoice"),e.log("Add Bill Invoice Activated",null,"add-bill-invoice",!0)})}function o(){w(null),S(null),x([]),R(null)}function a(){function e(e){function t(t){return console.log(t),console.log("Recip: "+t+" Tenant: "+e.Id()),t.User().Id()===e.Id()}var n=$.grep(x(),t);return 0===n.length}return s().then(function(){A(A().filter(e))})}function s(){return n.getTenants(A,r.sessionUser().HouseId())}function l(e){return n.getBillTypeById(w,e)}function c(){return k({BillType:w(),Recipients:ko.observableArray()})}function u(){C({User:ko.observable({FullName:ko.observable("Select a recipient")}),BillInvoice:k(),Paid:ko.observable(!1),Amount:ko.observable()})}function d(){ko.observable.fn.beforeAndAfterSubscribe=function(e,t){var n;t.subscribe(function(e){n=e},null,"beforeChange"),t.subscribe(function(r){e(t,n,r)})},$(".input-group.date").datepicker({autoclose:!0,todayHighlight:!0}),ko.observable.fn.beforeAndAfterSubscribe(g,S)}function p(){function r(){return $.each(x(),function(e,t){var r=n.createInvoiceRecipient(i);r.Amount(t.Amount()),r.Paid(t.Paid()),r.User(t.User())}),n.saveChanges().then(function(){return e.logSuccess("Invoice Created!",null,"add-bill-invoice",!0),t.navigate("#bills")})}if(!R())return e.logError("Please enter a due date for the invoice.",null,"add-bill-invoice",!0),void 0;var i=n.createBillInvoice(w());return i.DueDate(moment(R(),"DD/MM/YYYY").format("MM/DD/YYYY")),n.saveChanges().then(r)}function f(){ko.utils.arrayForEach(x(),function(){x.removeAll()}),S(0),R(""),a(),e.log("Changes undone!",null,"add-bill-invoice",!0)}function h(){E=!0;var e=0;ko.utils.arrayForEach(x(),function(t){console.log(e+=parseInt(t.Amount()))}),0==N&&S(e),E=!1}function g(e,t,n){var r=x().length;if(t!=n&&""!=n&&r>0&&0==E){var i=n/r;N=!0,ko.utils.arrayForEach(x(),function(e){e.Amount(i)}),N=!1}}function v(t){return t.Amount()?"Select a recipient"===t.User().FullName()?(e.logError("Please choose a recipient from the combo box.",null,"add-bill-invoice",!0),void 0):(t.Amount.subscribe(h),x.push(t),t.Amount.notifySubscribers(),a(),u(),void 0):(e.logError("Please enter a bill amount for the new recipient.",null,"add-bill-invoice",!0),void 0)}function m(e){x.remove(e),e.Amount.notifySubscribers(),a()}function b(e,t){t.User(e)}function y(t){t.Paid()?(t.Paid(!1),e.logSuccess(t.User().FullName().concat(" has now un-paid."),null,"add-bill-invoice",!0)):(t.Paid(!0),e.logSuccess(t.User().FullName().concat(" has now paid."),null,"add-bill-invoice",!0))}var _=new ko.observable,w=new ko.observable,k=new ko.observable,x=new ko.observableArray,C=new ko.observableArray,I=new ko.observable(!1),A=new ko.observableArray,S=new ko.observable(0),R=new ko.observable,E=!1,N=!1,D={activate:i,deactivate:o,title:"Add Bill Invoice View",attached:d,billType:w,billInvoice:k,pageHeader:_,clickedCombo:b,checkboxClicked:y,invoiceRecipients:x,newInvoiceRecipient:C,totalAmount:S,dueDate:R,addNewRecipient:v,removeRecipient:m,invoiceCreated:p,invoiceUndone:f,tenantsList:A,isUndoEnabled:I};return D});