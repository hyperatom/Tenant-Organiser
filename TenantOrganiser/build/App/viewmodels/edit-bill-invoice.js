define(["services/logger","plugins/router","services/datacontext","services/session"],function(e,t,n,r){function i(t){return Q.all([a(),s(t),l()]).then(function(){_("Edit "+w().Name()+" Invoice"),C(k().Recipients().slice()),o(),b();var t=0;ko.utils.arrayForEach(C(),function(e){e.Amount.subscribe(p),t+=e.Amount()}),R(t.toFixed(2)),x(moment(k().DueDate()).format("DD/MM/YYYY")),e.log("Add Bill Invoice Activated",null,"edit-bill-invoice",!0)})}function o(){function e(e){function t(t){return t.UserId()===e.Id()}var n=$.grep(C(),t);return 0===n.length}return a().then(function(){A(A().filter(e))})}function a(){return n.getTenants(A,r.sessionUser().HouseId())}function s(e){return n.getInvoiceById(k,e)}function l(){return w(k().BillType())}function c(){ko.observable.fn.beforeAndAfterSubscribe=function(e,t){var n;t.subscribe(function(e){n=e},null,"beforeChange"),t.subscribe(function(r){e(t,n,r)})},$(".input-group.date").datepicker({autoclose:!0,todayHighlight:!0}),ko.observable.fn.beforeAndAfterSubscribe(h,R)}function u(){function r(){t.navigate("#bills"),e.logSuccess("Invoice Saved!",null,"edit-bill-invoice",!0)}n.saveChanges().then(r)}function d(){return ko.utils.arrayForEach(C().slice(),function(e){e&&(C.remove(e),e.entityAspect.setDeleted())}),k().entityAspect.setDeleted(),n.saveChanges().then(function(){t.navigate("#bills"),e.logSuccess("Invoice Deleted!",null,"edit-bill-invoice",!0)})}function f(){C([]),n.rejectChanges(),C(k().Recipients().slice()),o(),b();var t=0;ko.utils.arrayForEach(C(),function(e){e.Amount.subscribe(p),t+=e.Amount()}),R(t.toFixed(2)),x(moment(k().DueDate()).format("DD/MM/YYYY")),e.log("Changes undone!",null,"edit-bill-invoice",!0)}function p(){E=!0;var e=0;ko.utils.arrayForEach(C(),function(t){e+=t.Amount()}),0==N&&R(e.toFixed(2)),E=!1}function h(e,t,n){var r=C().length;if(t!=n&&""!=n&&r>0&&0==E){var i=n/r;N=!0,ko.utils.arrayForEach(C(),function(e){e.Amount(i.toFixed(2))}),N=!1}}function g(t){if(!t.Amount())return e.logError("Please enter a bill amount for the new recipient.",null,"add-bill-invoice",!0),void 0;if("Select a recipient"===t.User().FullName())return e.logError("Please choose a recipient from the combo box.",null,"add-bill-invoice",!0),void 0;var r=n.createInvoiceRecipient(k());try{r.User(t.User()),r.Amount(t.Amount())}catch(i){return r.entityAspect.setDeleted(),e.logError("This recipient has already been added.",null,"add-bill-invoice",!0),void 0}C.push(r),r.Amount.subscribe(p),r.Amount.notifySubscribers(),o(),b()}function v(e){C.remove(e),e.entityAspect.setDeleted(),e.Amount.notifySubscribers(),o()}function b(){I({User:ko.observable({FullName:ko.observable("Select a recipient")}),BillInvoice:k(),Paid:ko.observable(!1),Amount:ko.observable()})}function m(e,t){t.User(e)}function y(t){t.Paid()?(t.Paid(!1),e.logSuccess(t.User().FullName().concat(" has now un-paid."),null,"edit-bill-invoice",!0)):(t.Paid(!0),e.logSuccess(t.User().FullName().concat(" has now paid."),null,"edit-bill-invoice",!0))}var _=new ko.observable,w=new ko.observable,k=new ko.observable,x=new ko.observable,C=new ko.observableArray,I=new ko.observableArray,A=new ko.observableArray,S=new ko.observable(""),R=new ko.observable(0),E=!1,N=!1,D={activate:i,title:"Add Bill Invoice View",attached:c,pageHeader:_,billType:w,billInvoice:k,dueDate:x,billName:S,clickedCombo:m,checkboxClicked:y,invoiceRecipients:C,newInvoiceRecipient:I,totalAmount:R,addNewRecipient:g,removeRecipient:v,invoiceSaved:u,invoiceDeleted:d,invoiceUndone:f,tenantsList:A};return D});