define(["services/logger","plugins/router","services/datacontext","services/session"],function(e,n,t,r){function o(n){return Q.all([a(),i(n),s()]).then(function(){y("Edit "+w().Name()+" Invoice"),x(k().Recipients().slice()),b();var n=0;ko.utils.arrayForEach(x(),function(e){e.Amount.subscribe(p),n+=e.Amount()}),S(n.toFixed(2)),C(moment(k().DueDate()).format("DD/MM/YYYY")),e.log("Add Bill Invoice Activated",null,"edit-bill-invoice",!0)})}function a(){return t.getTenants(A,r.sessionUser().HouseId())}function i(e){return t.getInvoiceById(k,e)}function s(){return w(k().BillType())}function l(){ko.observable.fn.beforeAndAfterSubscribe=function(e,n){var t;n.subscribe(function(e){t=e},null,"beforeChange"),n.subscribe(function(r){e(n,t,r)})},$(".input-group.date").datepicker({autoclose:!0,todayHighlight:!0}),ko.observable.fn.beforeAndAfterSubscribe(v,S)}function c(){function r(){n.navigate("#bills"),e.logSuccess("Invoice Saved!",null,"edit-bill-invoice",!0)}t.saveChanges().then(r)}function u(){return ko.utils.arrayForEach(x().slice(),function(e){e&&(x.remove(e),e.entityAspect.setDeleted())}),k().entityAspect.setDeleted(),t.saveChanges().then(function(){n.navigate("#bills"),e.logSuccess("Invoice Deleted!",null,"edit-bill-invoice",!0)})}function d(){x([]),t.rejectChanges(),x(k().Recipients().slice()),b();var n=0;ko.utils.arrayForEach(x(),function(e){e.Amount.subscribe(p),n+=e.Amount()}),S(n.toFixed(2)),C(moment(k().DueDate()).format("DD/MM/YYYY")),e.log("Changes undone!",null,"edit-bill-invoice",!0)}function p(){D=!0;var e=0;ko.utils.arrayForEach(x(),function(n){e+=n.Amount()}),0==N&&S(e.toFixed(2)),D=!1}function v(e,n,t){var r=x().length;if(n!=t&&""!=t&&r>0&&0==D){var o=t/r;N=!0,ko.utils.arrayForEach(x(),function(e){e.Amount(o.toFixed(2))}),N=!1}}function f(n){if(!n.Amount())return e.logError("Please enter a bill amount for the new recipient.",null,"add-bill-invoice",!0),void 0;if("Select a recipient"===n.User().FullName())return e.logError("Please choose a recipient from the combo box.",null,"add-bill-invoice",!0),void 0;var r=t.createInvoiceRecipient(k());try{r.User(n.User()),r.Amount(n.Amount())}catch(o){return r.entityAspect.setDeleted(),e.logError("This recipient has already been added.",null,"add-bill-invoice",!0),void 0}x.push(r),r.Amount.subscribe(p),r.Amount.notifySubscribers(),b()}function g(e){x.remove(e),e.entityAspect.setDeleted(),e.Amount.notifySubscribers()}function b(){I({User:ko.observable({FullName:ko.observable("Select a recipient")}),BillInvoice:k(),Paid:ko.observable(!1),Amount:ko.observable()})}function m(e,n){n.User(e)}function h(n){n.Paid()?(n.Paid(!1),e.logSuccess(n.User().FullName().concat(" has now un-paid."),null,"edit-bill-invoice",!0)):(n.Paid(!0),e.logSuccess(n.User().FullName().concat(" has now paid."),null,"edit-bill-invoice",!0))}var y=new ko.observable,w=new ko.observable,k=new ko.observable,C=new ko.observable,x=new ko.observableArray,I=new ko.observableArray,A=new ko.observableArray,U=new ko.observable(""),S=new ko.observable(0),D=!1,N=!1,T={activate:o,title:"Add Bill Invoice View",attached:l,pageHeader:y,billType:w,billInvoice:k,dueDate:C,billName:U,clickedCombo:m,checkboxClicked:h,invoiceRecipients:x,newInvoiceRecipient:I,totalAmount:S,addNewRecipient:f,removeRecipient:g,invoiceSaved:c,invoiceDeleted:u,invoiceUndone:d,tenantsList:A};return T});