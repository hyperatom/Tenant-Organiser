define(["services/logger","plugins/router","services/datacontext","services/session"],function(e,t,n,r){function i(t){return Q.all([o(),a(t),s()]).then(function(){y("Edit "+_().Name()+" Invoice"),x(w().Recipients().slice()),v();var t=0;ko.utils.arrayForEach(x(),function(e){e.Amount.subscribe(p),t+=e.Amount()}),S(t.toFixed(2)),k(moment(w().DueDate()).format("DD/MM/YYYY")),e.log("Add Bill Invoice Activated",null,"edit-bill-invoice",!0)})}function o(){return n.getTenants(A,r.sessionUser().HouseId())}function a(e){return n.getInvoiceById(w,e)}function s(){return _(w().BillType())}function l(){ko.observable.fn.beforeAndAfterSubscribe=function(e,t){var n;t.subscribe(function(e){n=e},null,"beforeChange"),t.subscribe(function(r){e(t,n,r)})},$(".input-group.date").datepicker({autoclose:!0,todayHighlight:!0}),ko.observable.fn.beforeAndAfterSubscribe(f,S)}function c(){function r(){t.navigate("#bills"),e.logSuccess("Invoice Saved!",null,"edit-bill-invoice",!0)}n.saveChanges().then(r)}function u(){return ko.utils.arrayForEach(x().slice(),function(e){e&&(x.remove(e),e.entityAspect.setDeleted())}),w().entityAspect.setDeleted(),n.saveChanges().then(function(){t.navigate("#bills"),e.logSuccess("Invoice Deleted!",null,"edit-bill-invoice",!0)})}function d(){x([]),n.rejectChanges(),x(w().Recipients().slice()),v();var t=0;ko.utils.arrayForEach(x(),function(e){e.Amount.subscribe(p),t+=e.Amount()}),S(t.toFixed(2)),k(moment(w().DueDate()).format("DD/MM/YYYY")),e.log("Changes undone!",null,"edit-bill-invoice",!0)}function p(){R=!0;var e=0;ko.utils.arrayForEach(x(),function(t){e+=t.Amount()}),0==E&&S(e.toFixed(2)),R=!1}function f(e,t,n){var r=x().length;if(t!=n&&""!=n&&r>0&&0==R){var i=n/r;E=!0,ko.utils.arrayForEach(x(),function(e){e.Amount(i.toFixed(2))}),E=!1}}function h(t){if(!t.Amount())return e.logError("Please enter a bill amount for the new recipient.",null,"add-bill-invoice",!0),void 0;if("Select a recipient"===t.User().FullName())return e.logError("Please choose a recipient from the combo box.",null,"add-bill-invoice",!0),void 0;var r=n.createInvoiceRecipient(w());try{r.User(t.User()),r.Amount(t.Amount())}catch(i){return r.entityAspect.setDeleted(),e.logError("This recipient has already been added.",null,"add-bill-invoice",!0),void 0}x.push(r),r.Amount.subscribe(p),r.Amount.notifySubscribers(),v()}function g(e){x.remove(e),e.entityAspect.setDeleted(),e.Amount.notifySubscribers()}function v(){C({User:ko.observable({FullName:ko.observable("Select a recipient")}),BillInvoice:w(),Paid:ko.observable(!1),Amount:ko.observable()})}function m(e,t){t.User(e)}function b(t){t.Paid()?(t.Paid(!1),e.logSuccess(t.User().FullName().concat(" has now un-paid."),null,"edit-bill-invoice",!0)):(t.Paid(!0),e.logSuccess(t.User().FullName().concat(" has now paid."),null,"edit-bill-invoice",!0))}var y=new ko.observable,_=new ko.observable,w=new ko.observable,k=new ko.observable,x=new ko.observableArray,C=new ko.observableArray,A=new ko.observableArray,I=new ko.observable(""),S=new ko.observable(0),R=!1,E=!1,N={activate:i,title:"Add Bill Invoice View",attached:l,pageHeader:y,billType:_,billInvoice:w,dueDate:k,billName:I,clickedCombo:m,checkboxClicked:b,invoiceRecipients:x,newInvoiceRecipient:C,totalAmount:S,addNewRecipient:h,removeRecipient:g,invoiceSaved:c,invoiceDeleted:u,invoiceUndone:d,tenantsList:A};return N});