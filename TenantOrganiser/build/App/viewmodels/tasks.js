define(["services/logger","services/datacontext","services/session"],function(e,n,t){function r(){return l(),k(s(moment().format("L"))),C(s(moment().format("L"))),Q.all([o(),a(),i()]).then(function(){c("bin",h(),k().Date(),x),c("cleaning",y(),C().Date(),I),h().length>0&&0===x().length&&p(),y().length>0&&0===I().length&&b(),e.log("Tasks View Activated",null,"tasks",!0)})}function o(){return n.getTenants(w,t.sessionUser().HouseId())}function a(){return n.getBinRotasByHouse(h,t.sessionUser().HouseId())}function i(){return n.getCleaningRotasByHouse(y,t.sessionUser().HouseId())}function s(e){var n=moment(e),t=function(){function e(){return moment(this.Date()).calendar(!0)}function t(){return moment(this.Date()).format("MMMM Do YYYY")}this.Date=new ko.observable(n),this.RelativeDate=new ko.computed(e,this),this.NavDate=new ko.computed(t,this)};return new t}function l(){if(!moment.fn.oldcalendar){var e=moment.langData()._calendar,n={calendar:{sameDay:"[Today]",nextDay:"[Tomorrow]",nextWeek:"dddd",lastDay:"[Yesterday]",lastWeek:"[last] dddd",nextMonth:"whooo",sameElse:"MMMM Do"}};moment.fn.oldcalendar=moment.fn.calendar,moment.fn.calendar=function(t){return t?moment.lang("en",n):moment.lang("en",e),this.oldcalendar()}}}function c(e,n,t,r){r([]),ko.utils.arrayForEach(n,function(n){var o=moment(n.StartDate()),a=moment(t),i=Math.abs(a.diff(o,"days"));0===i%n.OccuranceDays()&&(u(e,w(),n,i),r.push(n))})}function u(e,n,t,r){var o="bin"===e?d(n):v(n);if(t.TaskTenants||(t.TaskTenants=new ko.observable("")),0!==o.length){var a=r%o.length,i=o[a],s="",l=$.grep(n,function(n){return"bin"===e?n.UserSettings().BinCollectionRotaGroup()===i:n.UserSettings().CleaningRotaGroup()===i});$.each(l,function(e,n){return 0===e?(s+=n.FullName(),void 0):(s+="/"+n.FullName(),void 0)}),t.TaskTenants(s)}}function d(e){var n=[];return $.each(e,function(e,t){var r=t.UserSettings().BinCollectionRotaGroup();null!==r&&$.inArray(r,n)&&n.push(r)}),n}function v(e){var n=[];return $.each(e,function(e,t){var r=t.UserSettings().CleaningRotaGroup();null!==r&&$.inArray(r,n)&&n.push(r)}),n}function p(){for(var e=new ko.observableArray;0==e().length;)k().Date(moment(k().Date()).add("days",1)),c("bin",h(),k().Date(),e);x(e())}function f(){for(var e=new ko.observableArray;0==e().length;)k().Date(moment(k().Date()).subtract("days",1)),c("bin",h(),k().Date(),e);x(e())}function g(n){n.Completed(!n.Completed()),n.Completed()?e.logSuccess(n.Tenants+" Cleaned!",null,"tasks",!0):e.logSuccess(n.Tenants+" Un-Cleaned!",null,"tasks",!0)}function b(){for(var e=new ko.observableArray;0==e().length;)C().Date(moment(C().Date()).add("days",1)),c("cleaning",y(),C().Date(),e);I(e())}function m(){for(var e=new ko.observableArray;0==e().length;)C().Date(moment(C().Date()).subtract("days",1)),c("cleaning",y(),C().Date(),e);I(e())}var h=new ko.observableArray,y=new ko.observableArray,w=new ko.observableArray,k=new ko.observable,C=new ko.observable,x=new ko.observableArray,I=new ko.observableArray,A=new ko.observable,U={activate:r,title:"Tasks",cleanStatusClicked:g,AllBinRotas:h,AllCleaningRotas:y,CurrentBinDate:k,CurrentCleaningDate:C,CurrentBinRotas:x,CurrentCleaningRotas:I,BinRotaTenants:A,navPreviousCleaningRota:m,navNextCleaningRota:b,navPreviousBinRota:f,navNextBinRota:p};return U});