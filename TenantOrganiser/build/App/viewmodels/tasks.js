define(["services/logger","services/datacontext","services/session"],function(e,t,n){function r(){return c(),C(l(moment().format("L"))),A(l(moment().format("L"))),Q.all([o(),a(),s()]).then(function(){u("bin",w(),C().Date(),I),u("cleaning",_(),A().Date(),S),i(),console.log("Distinct Groups: "+k()),w().length>0&&0===I().length&&h(),_().length>0&&0===S().length&&b(),e.log("Tasks View Activated",null,"tasks",!0)})}function o(){return t.getTenants(x,n.sessionUser().HouseId())}function i(){return k(g(x()).length)}function a(){return t.getBinRotasByHouse(w,n.sessionUser().HouseId())}function s(){return t.getCleaningRotasByHouse(_,n.sessionUser().HouseId())}function l(e){var t=moment(e),n=function(){function e(){return moment(this.Date()).calendar(!0)}function n(){return moment(this.Date()).format("MMMM Do YYYY")}this.Date=new ko.observable(t),this.RelativeDate=new ko.computed(e,this),this.NavDate=new ko.computed(n,this)};return new n}function c(){if(!moment.fn.oldcalendar){var e=moment.langData()._calendar,t={calendar:{sameDay:"[Today]",nextDay:"[Tomorrow]",nextWeek:"dddd",lastDay:"[Yesterday]",lastWeek:"[last] dddd",nextMonth:"whooo",sameElse:"MMMM Do"}};moment.fn.oldcalendar=moment.fn.calendar,moment.fn.calendar=function(n){return n?moment.lang("en",t):moment.lang("en",e),this.oldcalendar()}}}function u(e,t,n,r){r([]),ko.utils.arrayForEach(t,function(t){var o=d(t.StartDate(),n);0===o%t.OccuranceDays()&&(f(e,x(),t,o,n,r().length),r.push(t))})}function d(e,t){var n=moment(e),r=moment(t);return Math.abs(r.diff(n,"days"))}function f(e,t,n,r,o,i){var a="bin"===e?p(t):g(t);if(n.TaskTenants("Nobody Assigned"),n.RotaGroup(0),0!==a.length){var s=0;"bin"===e?($.each(w(),function(e,t){s+=Math.floor(d(t.StartDate(),o)/t.OccuranceDays())}),s+=i):($.each(_(),function(e,t){s+=Math.floor(d(t.StartDate(),o)/t.OccuranceDays())}),s+=i);var l=s%a.length,c=a[l],u="",f=$.grep(t,function(t){return"bin"===e?t.UserSettings().BinCollectionRotaGroup()===c:t.UserSettings().CleaningRotaGroup()===c});$.each(f,function(e,t){return 0===e?(u+=t.FullName(),void 0):(u+="/"+t.FullName(),void 0)}),n.TaskTenants(u),n.RotaGroup(c),"cleaning"===e&&(console.log(n.Name()),$.each(n.CleaningLogs(),function(e,t){var r=0===moment(t.Date()).diff(o,"days");console.log("Log Date: "+t.Date()+" / Nav Date: "+moment(o).toString());var i=n.RotaGroup()===t.RotaGroup();return r&&i?(console.log("Setting Cleaned!"),n.Cleaned(!0),n.Log(t),!1):(n.Log(null),n.Cleaned(!1),void 0)}))}}function p(e){var t=[];return $.each(e,function(e,n){var r=n.UserSettings().BinCollectionRotaGroup();null!==r&&$.inArray(r,t)&&t.push(r)}),t}function g(e){var t=[];return $.each(e,function(e,n){var r=n.UserSettings().CleaningRotaGroup();null!==r&&$.inArray(r,t)&&t.push(r)}),t}function h(){for(var e=new ko.observableArray;0==e().length;)C().Date(moment(C().Date()).add("days",1)),u("bin",w(),C().Date(),e);I(e())}function v(){for(var e=new ko.observableArray;0==e().length;)C().Date(moment(C().Date()).subtract("days",1)),u("bin",w(),C().Date(),e);I(e())}function m(n){if(n.Cleaned())return console.log(n),n.Log().entityAspect.setDeleted(),n.Log(null),n.Cleaned(!1),t.saveChanges().then(function(){e.logSuccess(n.Name()+" Un-Cleaned!",null,"tasks",!0)});var r=t.createCleaningRotaLog();r.Date(A().Date().toString()),console.log(A().Date().toString()),r.RotaGroup(n.RotaGroup()),console.log(n.RotaGroup()),r.CleaningRota(n),console.log(n),n.Cleaned(!0),n.Log(r),t.saveChanges().then(function(){e.logSuccess(n.Name()+" Cleaned!",null,"tasks",!0)})}function b(){for(var e=new ko.observableArray;0==e().length;)A().Date(moment(A().Date()).add("days",1)),u("cleaning",_(),A().Date(),e);S(e())}function y(){for(var e=new ko.observableArray;0==e().length;)A().Date(moment(A().Date()).subtract("days",1)),u("cleaning",_(),A().Date(),e);S(e())}var w=new ko.observableArray,_=new ko.observableArray,k=new ko.observable,x=new ko.observableArray,C=new ko.observable,A=new ko.observable,I=new ko.observableArray,S=new ko.observableArray,R=new ko.observable,N={activate:r,title:"Tasks",distinctCleaningGroups:k,cleanStatusClicked:m,AllBinRotas:w,AllCleaningRotas:_,CurrentBinDate:C,CurrentCleaningDate:A,CurrentBinRotas:I,CurrentCleaningRotas:S,BinRotaTenants:R,navPreviousCleaningRota:y,navNextCleaningRota:b,navPreviousBinRota:v,navNextBinRota:h};return N});