define(["services/logger","services/datacontext","services/session"],function(e,t,n){function r(){return l(),_(s(moment().format("L"))),k(s(moment().format("L"))),Q.all([i(),o(),a()]).then(function(){c("bin",b(),_().Date(),x),c("cleaning",y(),k().Date(),C),b().length>0&&0===x().length&&p(),y().length>0&&0===C().length&&v(),e.log("Tasks View Activated",null,"tasks",!0)})}function i(){return t.getTenants(w,n.sessionUser().HouseId())}function o(){return t.getBinRotasByHouse(b,n.sessionUser().HouseId())}function a(){return t.getCleaningRotasByHouse(y,n.sessionUser().HouseId())}function s(e){var t=moment(e),n=function(){function e(){return moment(this.Date()).calendar(!0)}function n(){return moment(this.Date()).format("MMMM Do YYYY")}this.Date=new ko.observable(t),this.RelativeDate=new ko.computed(e,this),this.NavDate=new ko.computed(n,this)};return new n}function l(){if(!moment.fn.oldcalendar){var e=moment.langData()._calendar,t={calendar:{sameDay:"[Today]",nextDay:"[Tomorrow]",nextWeek:"dddd",lastDay:"[Yesterday]",lastWeek:"[last] dddd",nextMonth:"whooo",sameElse:"MMMM Do"}};moment.fn.oldcalendar=moment.fn.calendar,moment.fn.calendar=function(n){return n?moment.lang("en",t):moment.lang("en",e),this.oldcalendar()}}}function c(e,t,n,r){r([]),ko.utils.arrayForEach(t,function(t){var i=moment(t.StartDate()),o=moment(n),a=Math.abs(o.diff(i,"days"));0===a%t.OccuranceDays()&&(u(e,w(),t,a),r.push(t))})}function u(e,t,n,r){var i="bin"===e?d(t):f(t);if(n.TaskTenants||(n.TaskTenants=new ko.observable("")),0!==i.length){var o=r%i.length,a=i[o],s="",l=$.grep(t,function(t){return"bin"===e?t.UserSettings().BinCollectionRotaGroup()===a:t.UserSettings().CleaningRotaGroup()===a});$.each(l,function(e,t){return 0===e?(s+=t.FullName(),void 0):(s+="/"+t.FullName(),void 0)}),n.TaskTenants(s)}}function d(e){var t=[];return $.each(e,function(e,n){var r=n.UserSettings().BinCollectionRotaGroup();null!==r&&$.inArray(r,t)&&t.push(r)}),t}function f(e){var t=[];return $.each(e,function(e,n){var r=n.UserSettings().CleaningRotaGroup();null!==r&&$.inArray(r,t)&&t.push(r)}),t}function p(){for(var e=new ko.observableArray;0==e().length;)_().Date(moment(_().Date()).add("days",1)),c("bin",b(),_().Date(),e);x(e())}function g(){for(var e=new ko.observableArray;0==e().length;)_().Date(moment(_().Date()).subtract("days",1)),c("bin",b(),_().Date(),e);x(e())}function h(t){t.Completed(!t.Completed()),t.Completed()?e.logSuccess(t.Tenants+" Cleaned!",null,"tasks",!0):e.logSuccess(t.Tenants+" Un-Cleaned!",null,"tasks",!0)}function v(){for(var e=new ko.observableArray;0==e().length;)k().Date(moment(k().Date()).add("days",1)),c("cleaning",y(),k().Date(),e);C(e())}function m(){for(var e=new ko.observableArray;0==e().length;)k().Date(moment(k().Date()).subtract("days",1)),c("cleaning",y(),k().Date(),e);C(e())}var b=new ko.observableArray,y=new ko.observableArray,w=new ko.observableArray,_=new ko.observable,k=new ko.observable,x=new ko.observableArray,C=new ko.observableArray,A=new ko.observable,I={activate:r,title:"Tasks",cleanStatusClicked:h,AllBinRotas:b,AllCleaningRotas:y,CurrentBinDate:_,CurrentCleaningDate:k,CurrentBinRotas:x,CurrentCleaningRotas:C,BinRotaTenants:A,navPreviousCleaningRota:m,navNextCleaningRota:v,navPreviousBinRota:g,navNextBinRota:p};return I});