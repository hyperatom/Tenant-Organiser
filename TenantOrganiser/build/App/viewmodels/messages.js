define(["services/logger","services/datacontext","services/session"],function(e,t,n){function r(t){return Q.all([o(),a()]).then(function(){t&&v(t),e.log("Messages View Activated",null,"messages",!0)})}function i(){if(v()){var e=$.grep(b(),function(e){return console.log("Tenant Id: "+e.Id()+" / Param Id: "+v()),console.log(e.Id()===parseInt(v())),e.Id()===parseInt(v())});if(parseInt(v())===n.sessionUser().Id())return h();h().then(function(){p(e[0]),v(null)})}else m().length>0&&f(m()[0])}function o(){return t.getTenants(b,n.sessionUser().HouseId())}function a(){return t.getConversationsByHouse(m,n.sessionUser().HouseId()).then(s)}function s(){function e(e){function t(e){return e.UserId()===n.sessionUser().Id()}var r=$.grep(e.ConversationUsers(),t);return r.length>0}m(m().filter(e))}function l(){function e(e){function t(t){return t.UserId()===e.Id()}var n=$.grep(y().ConversationUsers(),t);return 0===n.length}return o().then(function(){b(b().filter(e))})}function c(e){var t=e.keyCode?e.keyCode:e.which;"13"==t&&u()}function u(){function e(){f(y())}if(w()){var r=t.createMessage(),i=w();return r.Content(i),r.Conversation(y()),r.UserSent(n.sessionUser()),t.saveChanges().then(e).then(a)}}function d(){$("#convo-panel").off("scrollTop"),$("#convo-panel").scrollTop($("#convo-panel")[0].scrollHeight)}function f(e){y(null),y(e),l(),w(""),$("#message-box").focus(),$("#message-box").off("keypress"),$("#message-box").keypress(c),d()}function p(e){return t.createConversationUser(y(),e),t.saveChanges().then(function(){l()})}function h(){function e(){f(r)}var r=t.createConversation(n.sessionUser);return r.DateStarted(moment().toString()),t.createConversationUser(r,n.sessionUser()),t.saveChanges().then(function(){return a().then(function(){return e()})})}function g(){function e(e){return e.UserId()===n.sessionUser().Id()}function r(e,t){t.entityAspect.setDeleted()}var i=$.grep(y().ConversationUsers(),e),o=y();return y(null),1===o.ConversationUsers().length?(o.Messages().length>0&&$.each(o.Messages().slice(),r),o.entityAspect.setDeleted()):o.ConversationUsers.remove(i[0]),i[0].entityAspect.setDeleted(),t.saveChanges().then(a)}var v=new ko.observable,b=new ko.observableArray,m=new ko.observableArray,y=new ko.observable,w=new ko.observable,_={activate:r,attached:i,title:"Messages",tenantsList:b,conversationsList:m,activeConversation:y,conversationClicked:f,createNewConversation:h,leaveConversation:g,recipientAdded:p,composingMessage:w,messageSent:u};return _});