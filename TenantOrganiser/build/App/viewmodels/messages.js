define(["services/logger","services/datacontext","services/session"],function(e,n,t){function r(){return n.getTenants(v,t.sessionUser().HouseId()),n.getConversations(b,t.sessionUser().HouseId()),e.log("Messages View Activated",null,"messages",!0),!0}function o(){}function a(){console.log(g()),$.each(v(),function(e,n){$.each(g().ConversationUsers(),function(e,t){return t.UserId()===n.Id()?(console.log(n),v.remove(n),!0):void 0})})}function i(){var e=new Conversation(new ko.observableArray,new ko.observableArray([{Name:"Adam",ProfilePicUrl:"../../Content/images/profile-picture.jpg"}]));b.push(e),u(e)}function s(e){var n=e.keyCode?e.keyCode:e.which;"13"==n&&l()}function l(){function e(){u(g())}if(f()){var r=n.createMessage(),o=f();return r.Content(o),r.Conversation(g()),r.UserSent(t.sessionUser()),n.saveChanges().then(e)}}function c(){$("#convo-panel").off("scrollTop"),$("#convo-panel").scrollTop($("#convo-panel")[0].scrollHeight)}function u(e){g(null),g(e),a(),f(""),$("#message-box").focus(),$("#message-box").off("keypress"),$("#message-box").keypress(s),c()}function d(e){g().recipients.remove(e)}function p(e){n.createConversationUser(g(),e),n.saveChanges()}var v=new ko.observableArray,b=new ko.observableArray,g=new ko.observable,f=new ko.observable,h={activate:r,title:"Messages",attached:o,tenantsList:v,conversationsList:b,activeConversation:g,conversationClicked:u,recipientAdded:p,recipientRemoved:d,composingMessage:f,messageSent:l,newConvoClicked:i};return h});