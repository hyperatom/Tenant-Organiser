define(["services/logger","services/datacontext","services/session"],function(e,n,t){function r(){return e.log("Messages View Activated",null,"messages",!0),Q.all([o(),a()])}function o(){return n.getTenants(g,t.sessionUser().HouseId())}function a(){return n.getConversationsByHouse(b,t.sessionUser().HouseId()).then(i)}function i(){function e(e){function n(e){return e.UserId()===t.sessionUser().Id()}var r=$.grep(e.ConversationUsers(),n);return r.length>0}b(b().filter(e))}function s(){function e(e){function n(n){return n.UserId()===e.Id()}var t=$.grep(m().ConversationUsers(),n);return 0===t.length}g(g().filter(e))}function l(e){var n=e.keyCode?e.keyCode:e.which;"13"==n&&c()}function c(){function e(){d(m())}if(h()){var r=n.createMessage(),o=h();return r.Content(o),r.Conversation(m()),r.UserSent(t.sessionUser()),n.saveChanges().then(e).then(a)}}function u(){$("#convo-panel").off("scrollTop"),$("#convo-panel").scrollTop($("#convo-panel")[0].scrollHeight)}function d(e){m(null),m(e),s(),h(""),$("#message-box").focus(),$("#message-box").off("keypress"),$("#message-box").keypress(l),u()}function v(e){return n.createConversationUser(m(),e),n.saveChanges()}function p(){function e(){d(r)}var r=n.createConversation(t.sessionUser);return r.DateStarted(moment().toString()),n.createConversationUser(r,t.sessionUser()),n.saveChanges().then(e).then(a)}function f(){function e(e){return e.UserId()===t.sessionUser().Id()}function r(e,n){n.entityAspect.setDeleted()}var o=$.grep(m().ConversationUsers(),e),i=m();return m(null),1===i.ConversationUsers().length?(i.Messages().length>0&&$.each(i.Messages().slice(),r),i.entityAspect.setDeleted()):i.ConversationUsers.remove(o[0]),o[0].entityAspect.setDeleted(),n.saveChanges().then(a)}var g=new ko.observableArray,b=new ko.observableArray,m=new ko.observable,h=new ko.observable,y={activate:r,title:"Messages",tenantsList:g,conversationsList:b,activeConversation:m,conversationClicked:d,createNewConversation:p,leaveConversation:f,recipientAdded:v,composingMessage:h,messageSent:c};return y});