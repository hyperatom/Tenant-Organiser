define(["services/logger","services/datacontext","services/session"],function(e,n,t){function r(){return e.log("Messages View Activated",null,"messages",!0),Q.all([a(),i()])}function o(){}function a(){return n.getTenants(v,t.sessionUser().HouseId())}function i(){return n.getConversations(b,t.sessionUser().HouseId())}function s(){$.each(v(),function(e,n){$.each(g().ConversationUsers(),function(e,t){return t.UserId()===n.Id()?(v.remove(n),!0):void 0})})}function l(e){var n=e.keyCode?e.keyCode:e.which;"13"==n&&c()}function c(){function e(){d(g())}if(f()){var r=n.createMessage(),o=f();return r.Content(o),r.Conversation(g()),r.UserSent(t.sessionUser()),n.saveChanges().then(e)}}function u(){$("#convo-panel").off("scrollTop"),$("#convo-panel").scrollTop($("#convo-panel")[0].scrollHeight)}function d(e){g(null),g(e),s(),f(""),$("#message-box").focus(),$("#message-box").off("keypress"),$("#message-box").keypress(l),u()}function p(e){return n.createConversationUser(g(),e),n.saveChanges()}var v=new ko.observableArray,b=new ko.observableArray,g=new ko.observable,f=new ko.observable,h={activate:r,title:"Messages",attached:o,tenantsList:v,conversationsList:b,activeConversation:g,conversationClicked:d,recipientAdded:p,composingMessage:f,messageSent:c,newConvoClicked:newConvoClicked};return h});