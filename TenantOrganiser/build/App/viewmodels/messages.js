define(["services/logger","services/datacontext","services/session"],function(e,t,n){function r(){return e.log("Messages View Activated",null,"messages",!0),Q.all([i(),o()])}function i(){return t.getTenants(g,n.sessionUser().HouseId())}function o(){return t.getConversationsByHouse(v,n.sessionUser().HouseId()).then(a)}function a(){function e(e){function t(e){return e.UserId()===n.sessionUser().Id()}var r=$.grep(e.ConversationUsers(),t);return r.length>0}v(v().filter(e))}function s(){function e(e){function t(t){return t.UserId()===e.Id()}var n=$.grep(m().ConversationUsers(),t);return 0===n.length}g(g().filter(e))}function l(e){var t=e.keyCode?e.keyCode:e.which;"13"==t&&c()}function c(){function e(){d(m())}if(b()){var r=t.createMessage(),i=b();return r.Content(i),r.Conversation(m()),r.UserSent(n.sessionUser()),t.saveChanges().then(e).then(o)}}function u(){$("#convo-panel").off("scrollTop"),$("#convo-panel").scrollTop($("#convo-panel")[0].scrollHeight)}function d(e){m(null),m(e),s(),b(""),$("#message-box").focus(),$("#message-box").off("keypress"),$("#message-box").keypress(l),u()}function f(e){return t.createConversationUser(m(),e),t.saveChanges()}function p(){function e(){d(r)}var r=t.createConversation(n.sessionUser);return r.DateStarted(moment().toString()),t.createConversationUser(r,n.sessionUser()),t.saveChanges().then(e).then(o)}function h(){function e(e){return e.UserId()===n.sessionUser().Id()}function r(e,t){t.entityAspect.setDeleted()}var i=$.grep(m().ConversationUsers(),e),a=m();return m(null),1===a.ConversationUsers().length?(a.Messages().length>0&&$.each(a.Messages().slice(),r),a.entityAspect.setDeleted()):a.ConversationUsers.remove(i[0]),i[0].entityAspect.setDeleted(),t.saveChanges().then(o)}var g=new ko.observableArray,v=new ko.observableArray,m=new ko.observable,b=new ko.observable,y={activate:r,title:"Messages",tenantsList:g,conversationsList:v,activeConversation:m,conversationClicked:d,createNewConversation:p,leaveConversation:h,recipientAdded:f,composingMessage:b,messageSent:c};return y});