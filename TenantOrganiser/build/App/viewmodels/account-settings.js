define(["services/logger","services/datacontext","services/session","plugins/router","durandal/app"],function(e,t,n,r,i){function o(){return S(n.sessionUser().IsFacebookUser()),Q.all([l(),c()]).then(function(){k(),e.log("Account Settings Activated",null,"account-settings",!0)})}function a(){if(!t.hasChanges())return!0;var e=i.showMessage("You have unsaved data. Are you sure you want to navigate?","Unsaved Data",["Yes","No"]);return e.then(function(e){return"No"===e?!1:("Yes"===e&&t.rejectChanges(),!0)})}function s(){for(var e in I)I[e].dispose()}function l(){return t.getPendingRequests(O,n.sessionUser().HouseId())}function c(){return t.getTenants(H,n.sessionUser().HouseId())}function u(){return Q.all([l(),c()])}function d(){e.logSuccess("Picture Uploaded!",null,"account-settings",!0)}function p(){t.leaveHouse(n.sessionUser).done(function(){return n.refreshSession().then(function(){r.navigate("#join-house"),e.logSuccess("You have left the house!",null,"account-settings",!0)})})}function f(n){return t.joinTenantToHouse(n.User,n.House).then(u).then(function(){e.logSuccess("Tenant Accepted!",null,"account-settings",!0)})}function h(e){var n=e;return O.remove(e),n.entityAspect.setDeleted(),Q.all([t.saveChanges(),l()])}function g(e){L(e)}function m(){return L().HouseId(null),t.saveChanges().then(c).then(function(){e.logSuccess("Tenant Removed.",null,"account-settings",!0)})}function v(r){return n.sessionUser().EmailNotifications(r),1==r?e.logSuccess("Email Notifications Enabled!",null,"account-settings",!0):e.logSuccess("Email Notifications Disabled!",null,"account-settings",!0),t.saveChanges().fail(function(){e.logSuccess("Email notifications could not be saved.",null,"account-settings",!0)})}function b(){if(F()!==M())return e.logError("Both passwords must match.",null,"account-settings",!0),void 0;var r=ko.observable();return t.getUserById(n.sessionUser().Id(),r).then(function(){function i(t){return t.errors?($.each(t.errors,function(n,r){e.logError(r,t.errors,"account-settings",!0)}),void 0):(e.logSuccess("User Password Saved!",null,"account-settings",!0),o())}function o(){var i=B().split(" ");return r().FirstName(i[0]),r().LastName(i[i.length-1]),r().Email(P()),t.saveChanges().then(function(){return E(!1),e.logSuccess("User Settings Saved!",null,"account-settings",!0),n.login(r().Email(),F())}).fail(function(){r().entityAspect.rejectChanges()})}return F()?n.changePassword(F()).then(i):o()})}function y(){return n.sessionUser().House().HouseName(N()),n.sessionUser().House().HouseCode(D()),t.saveChanges().then(function(){R(!1),e.logSuccess("House Settings Saved!",null,"account-settings",!0)}).fail(function(){e.logError("Error saving settings.",null,"account-settings",!0)})}function _(){D(n.sessionUser().House().HouseCode()),N(n.sessionUser().House().HouseName()),R(!1),e.logSuccess("House Settings Reset!",null,"account-settings",!0)}function w(){B(n.sessionUser().FullName()),P(n.sessionUser().Email()),F(""),M(""),n.sessionUser().entityAspect.rejectChanges(),E(!1),e.logSuccess("User Settings Reset!",null,"account-settings",!0)}function k(){x(),C(),A()}function x(){N(n.sessionUser().House().HouseName()),D(n.sessionUser().House().HouseCode()),I.push(N.subscribe(function(){R(!0)})),I.push(D.subscribe(function(){R(!0)}))}function C(){T(n.sessionUser().EmailNotifications()),U(n.sessionUser().DisplayPictureFilePath()),I.push(T.subscribe(v))}function A(){B(n.sessionUser().FullName()),P(n.sessionUser().Email()),F(""),M(""),I.push(B.subscribe(function(){E(!0)})),I.push(P.subscribe(function(){E(!0)})),I.push(F.subscribe(function(){E(!0)})),I.push(M.subscribe(function(){E(!0)}))}var I=[],S=new ko.observable,R=new ko.observable(!1),E=new ko.observable(!1),N=new ko.observable,D=new ko.observable,T=ko.observable(),U=new ko.observable,B=new ko.observable,P=new ko.observable,F=new ko.observable,M=new ko.observable,O=new ko.observableArray,H=new ko.observableArray,L=new ko.observable,j={activate:o,deactivate:s,canDeactivate:a,title:"Account Settings",houseName:N,houseCode:D,emailNotifications:T,displayPictureURL:U,fullName:B,email:P,password1:F,password2:M,pendingRequests:O,tenants:H,hasHouseChanged:R,hasUserInfoChanged:E,saveHousePanelClicked:y,undoHousePanelClicked:_,saveUserInfoClicked:b,undoUserInfoClicked:w,markDeleteTenant:g,deleteTenant:m,acceptTenant:f,rejectTenant:h,leaveHouseConfirmed:p,pictureUploaded:d,isFacebookUser:S};return j});