define(["services/logger","services/datacontext","services/session","plugins/router","durandal/app","./upload-facebook-picture"],function(e,t,n,r,i){function o(){return D(n.sessionUser().IsFacebookUser()),Q.all([p(),f()]).then(function(){A(),e.log("Account Settings Activated",null,"account-settings",!0)})}function a(){}function s(){return t.uploadFacebookPicture(J()).then(function(t){return t||e.logError("This picture could not be found.",null,"account-settings",!0),n.refreshSession()})}function l(){var r=new FormData;return r.append("profilePicture",$("#imageFile").get(0).files[0]),t.uploadFilePicture(r).then(function(t){return t||e.logError("This picture could not be found.",null,"account-settings",!0),n.refreshSession()})}function c(){return t.uploadUrlPicture(W()).then(function(t){return t||e.logError("This picture could not be found.",null,"account-settings",!0),n.refreshSession()})}function u(){if(!t.hasChanges())return!0;var e=i.showMessage("You have unsaved data. Are you sure you want to navigate?","Unsaved Data",["Yes","No"]);return e.then(function(e){return"No"===e?!1:("Yes"===e&&t.rejectChanges(),!0)})}function d(){for(var e in N)N[e].dispose()}function p(){return t.getPendingRequests(q,n.sessionUser().HouseId())}function f(){return t.getTenants(V,n.sessionUser().HouseId())}function h(){return Q.all([p(),f()])}function g(){e.logSuccess("Picture Uploaded!",null,"account-settings",!0)}function m(){t.leaveHouse(n.sessionUser).done(function(){return n.refreshSession().then(function(){r.navigate("#join-house"),e.logSuccess("You have left the house!",null,"account-settings",!0)})})}function v(n){return q.remove(n),t.joinTenantToHouse(n.User,n.House).then(function(){return h()}).then(function(){e.logSuccess("Tenant Accepted!",null,"account-settings",!0)})}function b(e){var n=e;return q.remove(e),n.entityAspect.setDeleted(),Q.all([t.saveChanges(),p()])}function y(e){z(e)}function _(){return z().HouseId(null),t.saveChanges().then(f).then(function(){e.logSuccess("Tenant Removed.",null,"account-settings",!0)})}function w(r){return n.sessionUser().EmailNotifications(r),1==r?e.logSuccess("Email Notifications Enabled!",null,"account-settings",!0):e.logSuccess("Email Notifications Disabled!",null,"account-settings",!0),t.saveChanges().fail(function(){e.logSuccess("Email notifications could not be saved.",null,"account-settings",!0)})}function k(){if(L()!==j())return e.logError("Both passwords must match.",null,"account-settings",!0),void 0;var r=ko.observable();return t.getUserById(n.sessionUser().Id(),r).then(function(){function i(t){return t.errors?($.each(t.errors,function(n,r){e.logError(r,t.errors,"account-settings",!0)}),void 0):(e.logSuccess("User Password Saved!",null,"account-settings",!0),o())}function o(){var i=O().split(" ");return r().FirstName(i[0]),r().LastName(i[i.length-1]),t.saveChanges().then(function(){return U(!1),e.logSuccess("User Settings Saved!",null,"account-settings",!0),n.changeEmail(H()).then(function(){return n.refreshSession()})}).fail(function(){r().entityAspect.rejectChanges()})}if(!L())return o();var a=CryptoJS.SHA256(L()).toString();return n.changePassword(a).then(i)})}function x(){return n.sessionUser().House().HouseName(P()),n.sessionUser().House().HouseCode(B()),t.saveChanges().then(function(){T(!1),e.logSuccess("House Settings Saved!",null,"account-settings",!0)}).fail(function(){e.logError("Error saving settings.",null,"account-settings",!0)})}function C(){B(n.sessionUser().House().HouseCode()),P(n.sessionUser().House().HouseName()),T(!1),e.logSuccess("House Settings Reset!",null,"account-settings",!0)}function I(){O(n.sessionUser().FullName()),H(n.sessionUser().Email()),L(""),j(""),n.sessionUser().entityAspect.rejectChanges(),U(!1),e.logSuccess("User Settings Reset!",null,"account-settings",!0)}function A(){S(),R(),E()}function S(){P(n.sessionUser().House().HouseName()),B(n.sessionUser().House().HouseCode()),N.push(P.subscribe(function(){T(!0)})),N.push(B.subscribe(function(){T(!0)}))}function R(){F(n.sessionUser().EmailNotifications()),M(n.sessionUser().DisplayPictureFilePath()),N.push(F.subscribe(w))}function E(){O(n.sessionUser().FullName()),H(n.sessionUser().Email()),L(""),j(""),N.push(O.subscribe(function(){U(!0)})),N.push(H.subscribe(function(){U(!0)})),N.push(L.subscribe(function(){U(!0)})),N.push(j.subscribe(function(){U(!0)}))}var N=[],D=new ko.observable,T=new ko.observable(!1),U=new ko.observable(!1),P=new ko.observable,B=new ko.observable,F=ko.observable(),M=ko.observable(),O=new ko.observable,H=new ko.observable,L=new ko.observable,j=new ko.observable,q=new ko.observableArray,V=new ko.observableArray,z=new ko.observable,W=new ko.observable,J=new ko.observable,Y={activate:o,deactivate:d,attached:a,canDeactivate:u,title:"Account Settings",houseName:P,houseCode:B,emailNotifications:F,displayPictureURL:M,fullName:O,email:H,password1:L,password2:j,pendingRequests:q,tenants:V,hasHouseChanged:T,hasUserInfoChanged:U,saveHousePanelClicked:x,undoHousePanelClicked:C,saveUserInfoClicked:k,undoUserInfoClicked:I,markDeleteTenant:y,deleteTenant:_,acceptTenant:v,rejectTenant:b,leaveHouseConfirmed:m,pictureUploaded:g,isFacebookUser:D,uploadFacebookPicture:s,uploadFilePicture:l,uploadUrlPicture:c,profilePictureUrl:W,facebookUsername:J,sessionUser:n.sessionUser};return Y});