define(["services/logger","services/datacontext","services/session","plugins/router","durandal/app"],function(e,n,t,r,o){function a(){return Q.all([l(),c()]).then(function(){C(),e.log("Account Settings Activated",null,"account-settings",!0)})}function i(){if(!n.hasChanges())return!0;var e=o.showMessage("You have unsaved data. Are you sure you want to navigate?","Unsaved Data",["Yes","No"]);return e.then(function(e){return"No"===e?!1:("Yes"===e&&n.rejectChanges(),!0)})}function s(){for(var e in U)U[e].dispose()}function l(){return n.getPendingRequests(F,t.sessionUser().HouseId())}function c(){return n.getTenants(_,t.sessionUser().HouseId())}function u(){return Q.all([l(),c()])}function d(){e.logSuccess("Picture Uploaded!",null,"account-settings",!0)}function p(){n.leaveHouse(t.sessionUser).done(function(){return t.refreshSession().then(function(){r.navigate("#join-house"),e.logSuccess("You have left the house!",null,"account-settings",!0)})})}function v(t){return n.joinTenantToHouse(t.User,t.House).then(u).then(function(){e.logSuccess("Tenant Accepted!",null,"account-settings",!0)})}function f(e){var t=e;return F.remove(e),t.entityAspect.setDeleted(),Q.all([n.saveChanges(),l()])}function g(e){j(e)}function b(){return j().HouseId(null),n.saveChanges().then(c).then(function(){e.logSuccess("Tenant Removed.",null,"account-settings",!0)})}function m(r){return t.sessionUser().EmailNotifications(r),1==r?e.logSuccess("Email Notifications Enabled!",null,"account-settings",!0):e.logSuccess("Email Notifications Disabled!",null,"account-settings",!0),n.saveChanges().fail(function(){e.logSuccess("Email notifications could not be saved.",null,"account-settings",!0)})}function h(){if(P()!==M())return e.logError("Both passwords must match.",null,"account-settings",!0),void 0;var r=ko.observable();return n.getUserById(t.sessionUser().Id(),r).then(function(){function o(n){return n.errors?($.each(n.errors,function(t,r){e.logError(r,n.errors,"account-settings",!0)}),void 0):(e.logSuccess("User Password Saved!",null,"account-settings",!0),a())}function a(){var o=B().split(" ");return r().FirstName(o[0]),r().LastName(o[o.length-1]),r().Email(E()),n.saveChanges().then(function(){return D(!1),e.logSuccess("User Settings Saved!",null,"account-settings",!0),t.login(r().Email(),P())}).fail(function(){r().entityAspect.rejectChanges()})}return P()?t.changePassword(P()).then(o):a()})}function y(){return t.sessionUser().House().HouseName(N()),t.sessionUser().House().HouseCode(T()),n.saveChanges().then(function(){S(!1),e.logSuccess("House Settings Saved!",null,"account-settings",!0)}).fail(function(){e.logError("Error saving settings.",null,"account-settings",!0)})}function w(){T(t.sessionUser().House().HouseCode()),N(t.sessionUser().House().HouseName()),S(!1),e.logSuccess("House Settings Reset!",null,"account-settings",!0)}function k(){B(t.sessionUser().FullName()),E(t.sessionUser().Email()),P(""),M(""),t.sessionUser().entityAspect.rejectChanges(),D(!1),e.logSuccess("User Settings Reset!",null,"account-settings",!0)}function C(){x(),I(),A()}function x(){N(t.sessionUser().House().HouseName()),T(t.sessionUser().House().HouseCode()),U.push(N.subscribe(function(){S(!0)})),U.push(T.subscribe(function(){S(!0)}))}function I(){R(t.sessionUser().EmailNotifications()),H(t.sessionUser().DisplayPictureFilePath()),U.push(R.subscribe(m))}function A(){B(t.sessionUser().FullName()),E(t.sessionUser().Email()),P(""),M(""),U.push(B.subscribe(function(){D(!0)})),U.push(E.subscribe(function(){D(!0)})),U.push(P.subscribe(function(){D(!0)})),U.push(M.subscribe(function(){D(!0)}))}var U=[],S=new ko.observable(!1),D=new ko.observable(!1),N=new ko.observable,T=new ko.observable,R=ko.observable(),H=new ko.observable,B=new ko.observable,E=new ko.observable,P=new ko.observable,M=new ko.observable,F=new ko.observableArray,_=new ko.observableArray,j=new ko.observable,O={activate:a,deactivate:s,canDeactivate:i,title:"Account Settings",houseName:N,houseCode:T,emailNotifications:R,displayPictureURL:H,fullName:B,email:E,password1:P,password2:M,pendingRequests:F,tenants:_,hasHouseChanged:S,hasUserInfoChanged:D,saveHousePanelClicked:y,undoHousePanelClicked:w,saveUserInfoClicked:h,undoUserInfoClicked:k,markDeleteTenant:g,deleteTenant:b,acceptTenant:v,rejectTenant:f,leaveHouseConfirmed:p,pictureUploaded:d};return O});