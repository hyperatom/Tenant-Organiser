define(["durandal/system","knockout"],function(e,n){function t(e){return void 0==e&&(e={}),e.closeOnDeactivate||(e.closeOnDeactivate=c.defaults.closeOnDeactivate),e.beforeActivate||(e.beforeActivate=c.defaults.beforeActivate),e.afterDeactivate||(e.afterDeactivate=c.defaults.afterDeactivate),e.affirmations||(e.affirmations=c.defaults.affirmations),e.interpretResponse||(e.interpretResponse=c.defaults.interpretResponse),e.areSameItem||(e.areSameItem=c.defaults.areSameItem),e}function r(n,t,r){return e.isArray(r)?n[t].apply(n,r):n[t](r)}function o(n,t,r,o,a){if(n&&n.deactivate){e.log("Deactivating",n);var i;try{i=n.deactivate(t)}catch(s){return e.error(s),o.resolve(!1),void 0}i&&i.then?i.then(function(){r.afterDeactivate(n,t,a),o.resolve(!0)},function(n){e.log(n),o.resolve(!1)}):(r.afterDeactivate(n,t,a),o.resolve(!0))}else n&&r.afterDeactivate(n,t,a),o.resolve(!0)}function a(n,t,o,a){if(n)if(n.activate){e.log("Activating",n);var i;try{i=r(n,"activate",a)}catch(s){return e.error(s),o(!1),void 0}i&&i.then?i.then(function(){t(n),o(!0)},function(n){e.log(n),o(!1)}):(t(n),o(!0))}else t(n),o(!0);else o(!0)}function i(n,t,r){return r.lifecycleData=null,e.defer(function(o){if(n&&n.canDeactivate){var a;try{a=n.canDeactivate(t)}catch(i){return e.error(i),o.resolve(!1),void 0}a.then?a.then(function(e){r.lifecycleData=e,o.resolve(r.interpretResponse(e))},function(n){e.error(n),o.resolve(!1)}):(r.lifecycleData=a,o.resolve(r.interpretResponse(a)))}else o.resolve(!0)}).promise()}function s(n,t,o,a){return o.lifecycleData=null,e.defer(function(i){if(n==t())return i.resolve(!0),void 0;if(n&&n.canActivate){var s;try{s=r(n,"canActivate",a)}catch(l){return e.error(l),i.resolve(!1),void 0}s.then?s.then(function(e){o.lifecycleData=e,i.resolve(o.interpretResponse(e))},function(n){e.error(n),i.resolve(!1)}):(o.lifecycleData=s,i.resolve(o.interpretResponse(s)))}else i.resolve(!0)}).promise()}function l(r,l){var c,u=n.observable(null);l=t(l);var d=n.computed({read:function(){return u()},write:function(e){d.viaSetter=!0,d.activateItem(e)}});return d.__activator__=!0,d.settings=l,l.activator=d,d.isActivating=n.observable(!1),d.canDeactivateItem=function(e,n){return i(e,n,l)},d.deactivateItem=function(n,t){return e.defer(function(e){d.canDeactivateItem(n,t).then(function(r){r?o(n,t,l,e,u):(d.notifySubscribers(),e.resolve(!1))})}).promise()},d.canActivateItem=function(e,n){return s(e,u,l,n)},d.activateItem=function(n,t){var r=d.viaSetter;return d.viaSetter=!1,e.defer(function(i){if(d.isActivating())return i.resolve(!1),void 0;d.isActivating(!0);var s=u();return l.areSameItem(s,n,c,t)?(d.isActivating(!1),i.resolve(!0),void 0):(d.canDeactivateItem(s,l.closeOnDeactivate).then(function(p){p?d.canActivateItem(n,t).then(function(p){p?e.defer(function(e){o(s,l.closeOnDeactivate,l,e)}).promise().then(function(){n=l.beforeActivate(n,t),a(n,u,function(e){c=t,d.isActivating(!1),i.resolve(e)},t)}):(r&&d.notifySubscribers(),d.isActivating(!1),i.resolve(!1))}):(r&&d.notifySubscribers(),d.isActivating(!1),i.resolve(!1))}),void 0)}).promise()},d.canActivate=function(){var e;return r?(e=r,r=!1):e=d(),d.canActivateItem(e)},d.activate=function(){var e;return r?(e=r,r=!1):e=d(),d.activateItem(e)},d.canDeactivate=function(e){return d.canDeactivateItem(d(),e)},d.deactivate=function(e){return d.deactivateItem(d(),e)},d.includeIn=function(e){e.canActivate=function(){return d.canActivate()},e.activate=function(){return d.activate()},e.canDeactivate=function(e){return d.canDeactivate(e)},e.deactivate=function(e){return d.deactivate(e)}},l.includeIn?d.includeIn(l.includeIn):r&&d.activate(),d.forItems=function(n){l.closeOnDeactivate=!1,l.determineNextItemToActivate=function(e,n){var t=n-1;return-1==t&&e.length>1?e[1]:t>-1&&t<e.length-1?e[t]:null},l.beforeActivate=function(e){var t=d();if(e){var r=n.indexOf(e);-1==r?n.push(e):e=n()[r]}else e=l.determineNextItemToActivate(n,t?n.indexOf(t):0);return e},l.afterDeactivate=function(e,t){t&&n.remove(e)};var t=d.canDeactivate;d.canDeactivate=function(r){return r?e.defer(function(e){function t(){for(var n=0;n<a.length;n++)if(!a[n])return e.resolve(!1),void 0;e.resolve(!0)}for(var o=n(),a=[],i=0;i<o.length;i++)d.canDeactivateItem(o[i],r).then(function(e){a.push(e),a.length==o.length&&t()})}).promise():t()};var r=d.deactivate;return d.deactivate=function(t){return t?e.defer(function(e){function r(r){d.deactivateItem(r,t).then(function(){a++,n.remove(r),a==i&&e.resolve()})}for(var o=n(),a=0,i=o.length,s=0;i>s;s++)r(o[s])}).promise():r()},d},d}var c,u={closeOnDeactivate:!0,affirmations:["yes","ok","true"],interpretResponse:function(t){return e.isObject(t)&&(t=t.can||!1),e.isString(t)?-1!==n.utils.arrayIndexOf(this.affirmations,t.toLowerCase()):t},areSameItem:function(e,n){return e==n},beforeActivate:function(e){return e},afterDeactivate:function(e,n,t){n&&t&&t(null)}};return c={defaults:u,create:l,isActivator:function(e){return e&&e.__activator__}}});