define(["durandal/system","durandal/viewEngine"],function(e,n){function t(e,n){for(var t=0;t<e.length;t++){var r=e[t],o=r.getAttribute("data-view");if(o==n)return r}}function r(e){return(e+"").replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1")}return{useConvention:function(e,n,t){e=e||"viewmodels",n=n||"views",t=t||n;var o=new RegExp(r(e),"gi");this.convertModuleIdToViewId=function(e){return e.replace(o,n)},this.translateViewIdToArea=function(e,n){return n&&"partial"!=n?t+"/"+n+"/"+e:t+"/"+e}},locateViewForObject:function(n,t,r){var o;if(n.getView&&(o=n.getView()))return this.locateView(o,t,r);if(n.viewUrl)return this.locateView(n.viewUrl,t,r);var a=e.getModuleId(n);return a?this.locateView(this.convertModuleIdToViewId(a),t,r):this.locateView(this.determineFallbackViewId(n),t,r)},convertModuleIdToViewId:function(e){return e},determineFallbackViewId:function(e){var n=/function (.{1,})\(/,t=n.exec(e.constructor.toString()),r=t&&t.length>1?t[1]:"";return"views/"+r},translateViewIdToArea:function(e){return e},locateView:function(r,o,a){if("string"==typeof r){var i;if(i=n.isViewUrl(r)?n.convertViewUrlToViewId(r):r,o&&(i=this.translateViewIdToArea(i,o)),a){var s=t(a,i);if(s)return e.defer(function(e){e.resolve(s)}).promise()}return n.createView(i)}return e.defer(function(e){e.resolve(r)}).promise()}}});