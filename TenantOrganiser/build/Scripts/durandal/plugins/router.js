define(["durandal/system","durandal/app","durandal/activator","durandal/events","durandal/composition","plugins/history","knockout","jquery"],function(e,t,n,r,i,o,a,s){function l(e){return e=e.replace(m,"\\$&").replace(g,"(?:$1)?").replace(h,function(e,t){return t?e:"([^/]+)"}).replace(v,"(.*?)"),new RegExp("^"+e+"$")}function c(e){var t=e.indexOf(":"),n=t>0?t-1:e.length;return e.substring(0,n)}function u(e,t){return-1!==e.indexOf(t,e.length-t.length)}function d(e,t){if(!e||!t)return!1;if(e.length!=t.length)return!1;for(var n=0,r=e.length;r>n;n++)if(e[n]!=t[n])return!1;return!0}var f,p,g=/\((.*?)\)/g,h=/(\(\?)?:\w+/g,v=/\*\w+/g,m=/[\-{}\[\]+?.,\\\^$|#\s]/g,b=/\/$/,y=function(){function i(e){return e.router&&e.router.parent==T}function s(e){R&&R.config.isActive&&R.config.isActive(e)}function g(t,n){e.log("Navigation Complete",t,n);var r=e.getModuleId(D);r&&T.trigger("router:navigation:from:"+r),D=t,s(!1),R=n,s(!0);var o=e.getModuleId(D);o&&T.trigger("router:navigation:to:"+o),i(t)||T.updateDocumentTitle(t,n),p.explicitNavigation=!1,p.navigatingBack=!1,T.trigger("router:navigation:complete",t,n,T)}function h(t,n){e.log("Navigation Cancelled"),T.activeInstruction(R),R&&T.navigate(R.fragment,!1),E(!1),p.explicitNavigation=!1,p.navigatingBack=!1,T.trigger("router:navigation:cancelled",t,n,T)}function v(t){e.log("Navigation Redirecting"),E(!1),p.explicitNavigation=!1,p.navigatingBack=!1,T.navigate(t,{trigger:!0,replace:!0})}function m(t,n,r){p.navigatingBack=!p.explicitNavigation&&D!=r.fragment,T.trigger("router:route:activating",n,r,T),t.activateItem(n,r.params).then(function(e){if(e){var o=D;if(g(n,r),i(n)){var a=r.fragment;r.queryString&&(a+="?"+r.queryString),n.router.loadUrl(a)}o==n&&(T.attached(),T.compositionComplete())}else t.settings.lifecycleData&&t.settings.lifecycleData.redirect?v(t.settings.lifecycleData.redirect):h(n,r);f&&(f.resolve(),f=null)}).fail(function(t){e.error(t)})}function w(t,n,r){var i=T.guardRoute(n,r);i?i.then?i.then(function(i){i?e.isString(i)?v(i):m(t,n,r):h(n,r)}):e.isString(i)?v(i):m(t,n,r):h(n,r)}function _(e,t,n){T.guardRoute?w(e,t,n):m(e,t,n)}function k(e){return R&&R.config.moduleId==e.config.moduleId&&D&&(D.canReuseForRoute&&D.canReuseForRoute.apply(D,e.params)||!D.canReuseForRoute&&D.router&&D.router.loadUrl)}function x(){if(!E()){var t=N.shift();N=[],t&&(E(!0),T.activeInstruction(t),k(t)?_(n.create(),D,t):e.acquire(t.config.moduleId).then(function(n){var r=e.resolveObject(n);_(U,r,t)}).fail(function(n){e.error("Failed to load routed module ("+t.config.moduleId+"). Details: "+n.message)}))}}function C(e){N.unshift(e),x()}function I(e,t,n){for(var r=e.exec(t).slice(1),i=0;i<r.length;i++){var o=r[i];r[i]=o?decodeURIComponent(o):null}var a=T.parseQueryString(n);return a&&r.push(a),{params:r,queryParams:a}}function A(t){T.trigger("router:route:before-config",t,T),e.isRegExp(t)?t.routePattern=t.route:(t.title=t.title||T.convertRouteToTitle(t.route),t.moduleId=t.moduleId||T.convertRouteToModuleId(t.route),t.hash=t.hash||T.convertRouteToHash(t.route),t.routePattern=l(t.route)),t.isActive=t.isActive||a.observable(!1),T.trigger("router:route:after-config",t,T),T.routes.push(t),T.route(t.routePattern,function(e,n){var r=I(t.routePattern,e,n);C({fragment:e,queryString:n,config:t,params:r.params,queryParams:r.queryParams})})}function S(t){if(e.isArray(t.route))for(var n=t.isActive||a.observable(!1),r=0,i=t.route.length;i>r;r++){var o=e.extend({},t);o.route=t.route[r],o.isActive=n,r>0&&delete o.nav,A(o)}else A(t);return T}var D,R,N=[],E=a.observable(!1),U=n.create(),T={handlers:[],routes:[],navigationModel:a.observableArray([]),activeItem:U,isNavigating:a.computed(function(){var e=U(),t=E(),n=e&&e.router&&e.router!=T&&e.router.isNavigating()?!0:!1;return t||n}),activeInstruction:a.observable(null),__router__:!0};return r.includeIn(T),U.settings.areSameItem=function(e,t,n,r){return e==t?d(n,r):!1},T.parseQueryString=function(e){var t,n;if(!e)return null;if(n=e.split("&"),0==n.length)return null;t={};for(var r=0;r<n.length;r++){var i=n[r];if(""!==i){var o=i.split("=");t[o[0]]=o[1]&&decodeURIComponent(o[1].replace(/\+/g," "))}}return t},T.route=function(e,t){T.handlers.push({routePattern:e,callback:t})},T.loadUrl=function(t){var n=T.handlers,r=null,i=t,a=t.indexOf("?");if(-1!=a&&(i=t.substring(0,a),r=t.substr(a+1)),T.relativeToParentRouter){var s=this.parent.activeInstruction();i=s.params.join("/"),i&&"/"==i.charAt(0)&&(i=i.substr(1)),i||(i=""),i=i.replace("//","/").replace("//","/")}i=i.replace(b,"");for(var l=0;l<n.length;l++){var c=n[l];if(c.routePattern.test(i))return c.callback(i,r),!0}return e.log("Route Not Found"),T.trigger("router:route:not-found",t,T),R&&o.navigate(R.fragment,{trigger:!1,replace:!0}),p.explicitNavigation=!1,p.navigatingBack=!1,!1},T.updateDocumentTitle=function(e,n){n.config.title?document.title=t.title?n.config.title+" | "+t.title:n.config.title:t.title&&(document.title=t.title)},T.navigate=function(e,t){return e&&-1!=e.indexOf("://")?(window.location.href=e,!0):(p.explicitNavigation=!0,o.navigate(e,t))},T.navigateBack=function(){o.navigateBack()},T.attached=function(){T.trigger("router:navigation:attached",D,R,T)},T.compositionComplete=function(){E(!1),T.trigger("router:navigation:composition-complete",D,R,T),x()},T.convertRouteToHash=function(e){if(T.relativeToParentRouter){var t=T.parent.activeInstruction(),n=t.config.hash+"/"+e;return o._hasPushState&&(n="/"+n),n=n.replace("//","/").replace("//","/")}return o._hasPushState?e:"#"+e},T.convertRouteToModuleId=function(e){return c(e)},T.convertRouteToTitle=function(e){var t=c(e);return t.substring(0,1).toUpperCase()+t.substring(1)},T.map=function(t,n){if(e.isArray(t)){for(var r=0;r<t.length;r++)T.map(t[r]);return T}return e.isString(t)||e.isRegExp(t)?(n?e.isString(n)&&(n={moduleId:n}):n={},n.route=t):n=t,S(n)},T.buildNavigationModel=function(t){for(var n=[],r=T.routes,i=t||100,o=0;o<r.length;o++){var a=r[o];a.nav&&(e.isNumber(a.nav)||(a.nav=++i),n.push(a))}return n.sort(function(e,t){return e.nav-t.nav}),T.navigationModel(n),T},T.mapUnknownRoutes=function(t,n){var r="*catchall",i=l(r);return T.route(i,function(a,s){var l=I(i,a,s),c={fragment:a,queryString:s,config:{route:r,routePattern:i},params:l.params,queryParams:l.queryParams};if(t)if(e.isString(t))c.config.moduleId=t,n&&o.navigate(n,{trigger:!1,replace:!0});else if(e.isFunction(t)){var u=t(c);if(u&&u.then)return u.then(function(){T.trigger("router:route:before-config",c.config,T),T.trigger("router:route:after-config",c.config,T),C(c)}),void 0}else c.config=t,c.config.route=r,c.config.routePattern=i;else c.config.moduleId=a;T.trigger("router:route:before-config",c.config,T),T.trigger("router:route:after-config",c.config,T),C(c)}),T},T.reset=function(){return R=D=void 0,T.handlers=[],T.routes=[],T.off(),delete T.options,T},T.makeRelative=function(t){return e.isString(t)&&(t={moduleId:t,route:t}),t.moduleId&&!u(t.moduleId,"/")&&(t.moduleId+="/"),t.route&&!u(t.route,"/")&&(t.route+="/"),t.fromParent&&(T.relativeToParentRouter=!0),T.on("router:route:before-config").then(function(e){t.moduleId&&(e.moduleId=t.moduleId+e.moduleId),t.route&&(e.route=""===e.route?t.route.substring(0,t.route.length-1):t.route+e.route)}),T},T.createChildRouter=function(){var e=y();return e.parent=T,e},T};return p=y(),p.explicitNavigation=!1,p.navigatingBack=!1,p.targetIsThisWindow=function(e){var t=s(e.target).attr("target");return!t||t===window.name||"_self"===t||"top"===t&&window===window.top?!0:!1},p.activate=function(t){return e.defer(function(n){if(f=n,p.options=e.extend({routeHandler:p.loadUrl},p.options,t),o.activate(p.options),o._hasPushState)for(var r=p.routes,i=r.length;i--;){var a=r[i];a.hash=a.hash.replace("#","")}s(document).delegate("a","click",function(e){if(o._hasPushState){if(!e.altKey&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey&&p.targetIsThisWindow(e)){var t=s(this).attr("href");null==t||"#"===t.charAt(0)||/^[a-z]+:/i.test(t)||(p.explicitNavigation=!0,e.preventDefault(),o.navigate(t))}}else p.explicitNavigation=!0}),o.options.silent&&f&&(f.resolve(),f=null)}).promise()},p.deactivate=function(){o.deactivate()},p.install=function(){a.bindingHandlers.router={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,r,o){var s=a.utils.unwrapObservable(t())||{};if(s.__router__)s={model:s.activeItem(),attached:s.attached,compositionComplete:s.compositionComplete,activate:!1};else{var l=a.utils.unwrapObservable(s.router||r.router)||p;s.model=l.activeItem(),s.attached=l.attached,s.compositionComplete=l.compositionComplete,s.activate=!1}i.compose(e,s,o)}},a.virtualElements.allowedBindings.router=!0},p});