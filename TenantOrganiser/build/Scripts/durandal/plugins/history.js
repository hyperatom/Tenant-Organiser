define(["durandal/system","jquery"],function(e,n){function t(e,n,t){if(t){var r=e.href.replace(/(javascript:|#).*$/,"");e.replace(r+"#"+n)}else e.hash="#"+n}var r=/^[#\/]|\s+$/g,o=/^\/+|\/+$/g,a=/msie [\w.]+/,i=/\/$/,s={interval:50,active:!1};return"undefined"!=typeof window&&(s.location=window.location,s.history=window.history),s.getHash=function(e){var n=(e||s).location.href.match(/#(.*)$/);return n?n[1]:""},s.getFragment=function(e,n){if(null==e)if(s._hasPushState||!s._wantsHashChange||n){e=s.location.pathname+s.location.search;var t=s.root.replace(i,"");e.indexOf(t)||(e=e.substr(t.length))}else e=s.getHash();return e.replace(r,"")},s.activate=function(t){s.active&&e.error("History has already been activated."),s.active=!0,s.options=e.extend({},{root:"/"},s.options,t),s.root=s.options.root,s._wantsHashChange=s.options.hashChange!==!1,s._wantsPushState=!!s.options.pushState,s._hasPushState=!!(s.options.pushState&&s.history&&s.history.pushState);var i=s.getFragment(),l=document.documentMode,c=a.exec(navigator.userAgent.toLowerCase())&&(!l||7>=l);s.root=("/"+s.root+"/").replace(o,"/"),c&&s._wantsHashChange&&(s.iframe=n('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,s.navigate(i,!1)),s._hasPushState?n(window).on("popstate",s.checkUrl):s._wantsHashChange&&"onhashchange"in window&&!c?n(window).on("hashchange",s.checkUrl):s._wantsHashChange&&(s._checkUrlInterval=setInterval(s.checkUrl,s.interval)),s.fragment=i;var u=s.location,d=u.pathname.replace(/[^\/]$/,"$&/")===s.root;if(s._wantsHashChange&&s._wantsPushState){if(!s._hasPushState&&!d)return s.fragment=s.getFragment(null,!0),s.location.replace(s.root+s.location.search+"#"+s.fragment),!0;s._hasPushState&&d&&u.hash&&(this.fragment=s.getHash().replace(r,""),this.history.replaceState({},document.title,s.root+s.fragment+u.search))}return s.options.silent?void 0:s.loadUrl()},s.deactivate=function(){n(window).off("popstate",s.checkUrl).off("hashchange",s.checkUrl),clearInterval(s._checkUrlInterval),s.active=!1},s.checkUrl=function(){var e=s.getFragment();return e===s.fragment&&s.iframe&&(e=s.getFragment(s.getHash(s.iframe))),e===s.fragment?!1:(s.iframe&&s.navigate(e,!1),s.loadUrl(),void 0)},s.loadUrl=function(e){var n=s.fragment=s.getFragment(e);return s.options.routeHandler?s.options.routeHandler(n):!1},s.navigate=function(n,r){if(!s.active)return!1;if(void 0===r?r={trigger:!0}:e.isBoolean(r)&&(r={trigger:r}),n=s.getFragment(n||""),s.fragment!==n){s.fragment=n;var o=s.root+n;if(""===n&&"/"!==o&&(o=o.slice(0,-1)),s._hasPushState)s.history[r.replace?"replaceState":"pushState"]({},document.title,o);else{if(!s._wantsHashChange)return s.location.assign(o);t(s.location,n,r.replace),s.iframe&&n!==s.getFragment(s.getHash(s.iframe))&&(r.replace||s.iframe.document.open().close(),t(s.iframe.location,n,r.replace))}return r.trigger?s.loadUrl(n):void 0}},s.navigateBack=function(){s.history.back()},s});