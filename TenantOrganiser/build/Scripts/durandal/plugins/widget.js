define(["durandal/system","durandal/composition","jquery","knockout"],function(e,n,t,r){function o(e,t){var o=r.utils.domData.get(e,l);o||(o={parts:n.cloneNodes(r.virtualElements.childNodes(e))},r.virtualElements.emptyNode(e),r.utils.domData.set(e,l,o)),t.parts=o.parts}var i={},a={},s=["model","view","kind"],l="durandal-widget-data",c={getSettings:function(n){var t=r.utils.unwrapObservable(n())||{};if(e.isString(t))return{kind:t};for(var o in t)t[o]=-1!=r.utils.arrayIndexOf(s,o)?r.utils.unwrapObservable(t[o]):t[o];return t},registerKind:function(e){r.bindingHandlers[e]={init:function(){return{controlsDescendantBindings:!0}},update:function(n,t,r,i,a){var s=c.getSettings(t);s.kind=e,o(n,s),c.create(n,s,a,!0)}},r.virtualElements.allowedBindings[e]=!0,n.composeBindings.push(e+":")},mapKind:function(e,n,t){n&&(a[e]=n),t&&(i[e]=t)},mapKindToModuleId:function(e){return i[e]||c.convertKindToModulePath(e)},convertKindToModulePath:function(e){return"widgets/"+e+"/viewmodel"},mapKindToViewId:function(e){return a[e]||c.convertKindToViewPath(e)},convertKindToViewPath:function(e){return"widgets/"+e+"/view"},createCompositionSettings:function(e,n){return n.model||(n.model=this.mapKindToModuleId(n.kind)),n.view||(n.view=this.mapKindToViewId(n.kind)),n.preserveContext=!0,n.activate=!0,n.activationData=n,n.mode="templated",n},create:function(e,t,r,o){o||(t=c.getSettings(function(){return t},e));var i=c.createCompositionSettings(e,t);n.compose(e,i,r)},install:function(e){if(e.bindingName=e.bindingName||"widget",e.kinds)for(var t=e.kinds,i=0;i<t.length;i++)c.registerKind(t[i]);r.bindingHandlers[e.bindingName]={init:function(){return{controlsDescendantBindings:!0}},update:function(e,n,t,r,i){var a=c.getSettings(n);o(e,a),c.create(e,a,i,!0)}},n.composeBindings.push(e.bindingName+":"),r.virtualElements.allowedBindings[e.bindingName]=!0}};return c});