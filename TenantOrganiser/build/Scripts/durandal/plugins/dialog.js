define(["durandal/system","durandal/app","durandal/composition","durandal/activator","durandal/viewEngine","jquery","knockout"],function(e,n,t,r,o,a,i){function s(n){return e.defer(function(t){e.isString(n)?e.acquire(n).then(function(n){t.resolve(e.resolveObject(n))}).fail(function(t){e.error("Failed to load dialog module ("+n+"). Details: "+t.message)}):t.resolve(n)}).promise()}var l,c={},u=0,d=function(e,n,t){this.message=e,this.title=n||d.defaultTitle,this.options=t||d.defaultOptions};return d.prototype.selectOption=function(e){l.close(this,e)},d.prototype.getView=function(){return o.processMarkup(d.defaultViewMarkup)},d.setViewUrl=function(e){delete d.prototype.getView,d.prototype.viewUrl=e},d.defaultTitle=n.title||"Application",d.defaultOptions=["Ok"],d.defaultViewMarkup=['<div data-view="plugins/messageBox" class="messageBox">','<div class="modal-header">','<h3 data-bind="text: title"></h3>',"</div>",'<div class="modal-body">','<p class="message" data-bind="text: message"></p>',"</div>",'<div class="modal-footer" data-bind="foreach: options">','<button class="btn" data-bind="click: function () { $parent.selectOption($data); }, text: $data, css: { \'btn-primary\': $index() == 0, autofocus: $index() == 0 }"></button>',"</div>","</div>"].join("\n"),l={MessageBox:d,currentZIndex:1050,getNextZIndex:function(){return++this.currentZIndex},isOpen:function(){return u>0},getContext:function(e){return c[e||"default"]},addContext:function(e,n){n.name=e,c[e]=n;var t="show"+e.substr(0,1).toUpperCase()+e.substr(1);this[t]=function(n,t){return this.show(n,t,e)}},createCompositionSettings:function(e,n){var t={model:e,activate:!1,transition:!1};return n.attached&&(t.attached=n.attached),n.compositionComplete&&(t.compositionComplete=n.compositionComplete),t},getDialog:function(e){return e?e.__dialog__:void 0},close:function(e){var n=this.getDialog(e);if(n){var t=Array.prototype.slice.call(arguments,1);n.close.apply(n,t)}},show:function(n,o,a){var i=this,l=c[a||"default"];return e.defer(function(e){s(n).then(function(n){var a=r.create();a.activateItem(n,o).then(function(r){if(r){var o=n.__dialog__={owner:n,context:l,activator:a,close:function(){var t=arguments;a.deactivateItem(n,!0).then(function(r){r&&(u--,l.removeHost(o),delete n.__dialog__,0===t.length?e.resolve():1===t.length?e.resolve(t[0]):e.resolve.apply(e,t))})}};o.settings=i.createCompositionSettings(n,l),l.addHost(o),u++,t.compose(o.host,o.settings)}else e.resolve(!1)})})}).promise()},showMessage:function(n,t,r){return e.isString(this.MessageBox)?l.show(this.MessageBox,[n,t||d.defaultTitle,r||d.defaultOptions]):l.show(new this.MessageBox(n,t,r))},install:function(e){n.showDialog=function(e,n,t){return l.show(e,n,t)},n.showMessage=function(e,n,t){return l.showMessage(e,n,t)},e.messageBox&&(l.MessageBox=e.messageBox),e.messageBoxView&&(l.MessageBox.prototype.getView=function(){return e.messageBoxView})}},l.addContext("default",{blockoutOpacity:.2,removeDelay:200,addHost:function(e){var n=a("body"),t=a('<div class="modalBlockout"></div>').css({"z-index":l.getNextZIndex(),opacity:this.blockoutOpacity}).appendTo(n),r=a('<div class="modalHost"></div>').css({"z-index":l.getNextZIndex()}).appendTo(n);if(e.host=r.get(0),e.blockout=t.get(0),!l.isOpen()){e.oldBodyMarginRight=n.css("margin-right"),e.oldInlineMarginRight=n.get(0).style.marginRight;var o=a("html"),i=n.outerWidth(!0),s=o.scrollTop();a("html").css("overflow-y","hidden");var c=a("body").outerWidth(!0);n.css("margin-right",c-i+parseInt(e.oldBodyMarginRight,10)+"px"),o.scrollTop(s)}},removeHost:function(e){if(a(e.host).css("opacity",0),a(e.blockout).css("opacity",0),setTimeout(function(){i.removeNode(e.host),i.removeNode(e.blockout)},this.removeDelay),!l.isOpen()){var n=a("html"),t=n.scrollTop();n.css("overflow-y","").scrollTop(t),e.oldInlineMarginRight?a("body").css("margin-right",e.oldBodyMarginRight):a("body").css("margin-right","")}},attached:function(e){a(e).css("visibility","hidden")},compositionComplete:function(e,n,t){var r=l.getDialog(t.model),o=a(e),i=o.find("img").filter(function(){var e=a(this);return!(this.style.width&&this.style.height||e.attr("width")&&e.attr("height"))});o.data("predefinedWidth",o.get(0).style.width);var s=function(){setTimeout(function(){o.data("predefinedWidth")||o.css({width:""});var e=o.outerWidth(!1),n=o.outerHeight(!1),t=a(window).height(),i=Math.min(n,t);o.css({"margin-top":(-i/2).toString()+"px","margin-left":(-e/2).toString()+"px"}),o.data("predefinedWidth")||o.outerWidth(e),n>t?o.css("overflow-y","auto"):o.css("overflow-y",""),a(r.host).css("opacity",1),o.css("visibility","visible"),o.find(".autofocus").first().focus()},1)};s(),i.load(s),o.hasClass("autoclose")&&a(r.blockout).click(function(){r.close()})}}),l});