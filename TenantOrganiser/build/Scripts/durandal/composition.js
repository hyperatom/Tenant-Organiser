define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(e,n,t,r,o,a,i){function s(e){for(var n=[],t={childElements:n,activeView:null},r=i.virtualElements.firstChild(e);r;)1==r.nodeType&&(n.push(r),r.getAttribute(k)&&(t.activeView=r)),r=i.virtualElements.nextSibling(r);return t.activeView||(t.activeView=n[0]),t}function l(){I--,0===I&&setTimeout(function(){for(var n=C.length;n--;)try{C[n]()}catch(t){e.error(t)}C=[]},1)}function c(e){delete e.activeView,delete e.viewElements}function u(n,t,r){if(r)t();else if(n.activate&&n.model&&n.model.activate){var o;try{o=e.isArray(n.activationData)?n.model.activate.apply(n.model,n.activationData):n.model.activate(n.activationData),o&&o.then?o.then(t,function(n){e.error(n),t()}):o||void 0===o?t():(l(),c(n))}catch(a){e.error(a)}}else t()}function d(){var n=this;if(n.activeView&&n.activeView.removeAttribute(k),n.child)try{n.model&&n.model.attached&&(n.composingNewView||n.alwaysTriggerAttach)&&n.model.attached(n.child,n.parent,n),n.attached&&n.attached(n.child,n.parent,n),n.child.setAttribute(k,!0),n.composingNewView&&n.model&&n.model.detached&&i.utils.domNodeDisposal.addDisposeCallback(n.child,function(){try{n.model.detached(n.child,n.parent,n)}catch(t){e.error(t)}})}catch(t){e.error(t)}n.triggerAttach=e.noop}function v(n){if(e.isString(n.transition)){if(n.activeView){if(n.activeView==n.child)return!1;if(!n.child)return!0;if(n.skipTransitionOnSameViewId){var t=n.activeView.getAttribute("data-view"),r=n.child.getAttribute("data-view");return t!=r}}return!0}return!1}function f(e){for(var n=0,t=e.length,r=[];t>n;n++){var o=e[n].cloneNode(!0);r.push(o)}return r}function p(e){var n=f(e.parts),t=y.getParts(n,null,!0),r=y.getParts(e.child);for(var o in t)a(r[o]).replaceWith(t[o])}function g(n){var t,r,o=i.virtualElements.childNodes(n.parent);if(!e.isArray(o)){var a=[];for(t=0,r=o.length;r>t;t++)a[t]=o[t];o=a}for(t=1,r=o.length;r>t;t++)i.removeNode(o[t])}function b(e){i.utils.domData.set(e,S,e.style.display),e.style.display="none"}function m(e){e.style.display=i.utils.domData.get(e,S)}function h(e){var n=e.getAttribute("data-bind");if(!n)return!1;for(var t=0,r=U.length;r>t;t++)if(n.indexOf(U[t])>-1)return!0;return!1}var y,w={},k="data-active-view",C=[],I=0,A="durandal-composition-data",x="data-part",D=["model","view","transition","area","strategy","activationData"],S="durandal-visibility-data",U=["compose:"],N={complete:function(e){C.push(e)}};return y={composeBindings:U,convertTransitionToModuleId:function(e){return"transitions/"+e},defaultTransitionName:null,current:N,addBindingHandler:function(e,n,t){var r,o,a="composition-handler-"+e;n=n||i.bindingHandlers[e],t=t||function(){return void 0},o=i.bindingHandlers[e]={init:function(e,r,o,s,l){if(I>0){var c={trigger:i.observable(null)};y.current.complete(function(){n.init&&n.init(e,r,o,s,l),n.update&&(i.utils.domData.set(e,a,n),c.trigger("trigger"))}),i.utils.domData.set(e,a,c)}else i.utils.domData.set(e,a,n),n.init&&n.init(e,r,o,s,l);return t(e,r,o,s,l)},update:function(e,n,t,r,o){var s=i.utils.domData.get(e,a);return s.update?s.update(e,n,t,r,o):(s.trigger&&s.trigger(),void 0)}};for(r in n)"init"!==r&&"update"!==r&&(o[r]=n[r])},getParts:function(e,n,t){if(n=n||{},!e)return n;void 0===e.length&&(e=[e]);for(var r=0,o=e.length;o>r;r++){var a=e[r];if(a.getAttribute){if(!t&&h(a))continue;var i=a.getAttribute(x);i&&(n[i]=a),!t&&a.hasChildNodes()&&y.getParts(a.childNodes,n)}}return n},cloneNodes:f,finalize:function(n){if(void 0===n.transition&&(n.transition=this.defaultTransitionName),n.child||n.activeView)if(v(n)){var r=this.convertTransitionToModuleId(n.transition);e.acquire(r).then(function(e){n.transition=e,e(n).then(function(){if(n.cacheViews){if(n.activeView){var e=t.getBindingInstruction(n.activeView);e&&void 0!=e.cacheViews&&!e.cacheViews&&i.removeNode(n.activeView)}}else n.child?g(n):i.virtualElements.emptyNode(n.parent);n.triggerAttach(),l(),c(n)})}).fail(function(n){e.error("Failed to load transition ("+r+"). Details: "+n.message)})}else{if(n.child!=n.activeView){if(n.cacheViews&&n.activeView){var o=t.getBindingInstruction(n.activeView);!o||void 0!=o.cacheViews&&!o.cacheViews?i.removeNode(n.activeView):b(n.activeView)}n.child?(n.cacheViews||g(n),m(n.child)):n.cacheViews||i.virtualElements.emptyNode(n.parent)}n.triggerAttach(),l(),c(n)}else n.cacheViews||i.virtualElements.emptyNode(n.parent),n.triggerAttach(),l(),c(n)},bindAndShow:function(e,n,o){n.child=e,n.composingNewView=n.cacheViews?-1==i.utils.arrayIndexOf(n.viewElements,e):!0,u(n,function(){if(n.binding&&n.binding(n.child,n.parent,n),n.preserveContext&&n.bindingContext)n.composingNewView&&(n.parts&&p(n),b(e),i.virtualElements.prepend(n.parent,e),t.bindContext(n.bindingContext,e,n.model));else if(e){var o=n.model||w,a=i.dataFor(e);if(a!=o){if(!n.composingNewView)return i.removeNode(e),r.createView(e.getAttribute("data-view")).then(function(e){y.bindAndShow(e,n,!0)}),void 0;n.parts&&p(n),b(e),i.virtualElements.prepend(n.parent,e),t.bind(o,e)}}y.finalize(n)},o)},defaultStrategy:function(e){return n.locateViewForObject(e.model,e.area,e.viewElements)},getSettings:function(n){var t,a=n(),s=i.utils.unwrapObservable(a)||{},l=o.isActivator(a);if(e.isString(s))return s=r.isViewUrl(s)?{view:s}:{model:s,activate:!0};if(t=e.getModuleId(s))return s={model:s,activate:!0};!l&&s.model&&(l=o.isActivator(s.model));for(var c in s)s[c]=-1!=i.utils.arrayIndexOf(D,c)?i.utils.unwrapObservable(s[c]):s[c];return l?s.activate=!1:void 0===s.activate&&(s.activate=!0),s},executeStrategy:function(e){e.strategy(e).then(function(n){y.bindAndShow(n,e)})},inject:function(t){return t.model?t.view?(n.locateView(t.view,t.area,t.viewElements).then(function(e){y.bindAndShow(e,t)}),void 0):(t.strategy||(t.strategy=this.defaultStrategy),e.isString(t.strategy)?e.acquire(t.strategy).then(function(e){t.strategy=e,y.executeStrategy(t)}).fail(function(n){e.error("Failed to load view strategy ("+t.strategy+"). Details: "+n.message)}):this.executeStrategy(t),void 0):(this.bindAndShow(null,t),void 0)},compose:function(t,r,o,a){I++,a||(r=y.getSettings(function(){return r},t)),r.compositionComplete&&C.push(function(){r.compositionComplete(r.child,r.parent,r)}),C.push(function(){r.composingNewView&&r.model&&r.model.compositionComplete&&r.model.compositionComplete(r.child,r.parent,r)});var i=s(t);r.activeView=i.activeView,r.parent=t,r.triggerAttach=d,r.bindingContext=o,r.cacheViews&&!r.viewElements&&(r.viewElements=i.childElements),r.model?e.isString(r.model)?e.acquire(r.model).then(function(n){r.model=e.resolveObject(n),y.inject(r)}).fail(function(n){e.error("Failed to load composed module ("+r.model+"). Details: "+n.message)}):y.inject(r):r.view?(r.area=r.area||"partial",r.preserveContext=!0,n.locateView(r.view,r.area,r.viewElements).then(function(e){y.bindAndShow(e,r)})):this.bindAndShow(null,r)}},i.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(e,n,t,o,a){var s=y.getSettings(n,e);if(s.mode){var l=i.utils.domData.get(e,A);if(!l){var c=i.virtualElements.childNodes(e);l={},"inline"===s.mode?l.view=r.ensureSingleElement(c):"templated"===s.mode&&(l.parts=f(c)),i.virtualElements.emptyNode(e),i.utils.domData.set(e,A,l)}"inline"===s.mode?s.view=l.view.cloneNode(!0):"templated"===s.mode&&(s.parts=l.parts),s.preserveContext=!0}y.compose(e,s,a,!0)}},i.virtualElements.allowedBindings.compose=!0,y});