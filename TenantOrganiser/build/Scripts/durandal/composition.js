define(["durandal/system","durandal/viewLocator","durandal/binder","durandal/viewEngine","durandal/activator","jquery","knockout"],function(e,t,n,r,i,o,a){function s(e){for(var t=[],n={childElements:t,activeView:null},r=a.virtualElements.firstChild(e);r;)1==r.nodeType&&(t.push(r),r.getAttribute(_)&&(n.activeView=r)),r=a.virtualElements.nextSibling(r);return n.activeView||(n.activeView=t[0]),n}function l(){x--,0===x&&setTimeout(function(){for(var t=k.length;t--;)try{k[t]()}catch(n){e.error(n)}k=[]},1)}function c(e){delete e.activeView,delete e.viewElements}function u(t,n,r){if(r)n();else if(t.activate&&t.model&&t.model.activate){var i;try{i=e.isArray(t.activationData)?t.model.activate.apply(t.model,t.activationData):t.model.activate(t.activationData),i&&i.then?i.then(n,function(t){e.error(t),n()}):i||void 0===i?n():(l(),c(t))}catch(o){e.error(o)}}else n()}function d(){var t=this;if(t.activeView&&t.activeView.removeAttribute(_),t.child)try{t.model&&t.model.attached&&(t.composingNewView||t.alwaysTriggerAttach)&&t.model.attached(t.child,t.parent,t),t.attached&&t.attached(t.child,t.parent,t),t.child.setAttribute(_,!0),t.composingNewView&&t.model&&t.model.detached&&a.utils.domNodeDisposal.addDisposeCallback(t.child,function(){try{t.model.detached(t.child,t.parent,t)}catch(n){e.error(n)}})}catch(n){e.error(n)}t.triggerAttach=e.noop}function f(t){if(e.isString(t.transition)){if(t.activeView){if(t.activeView==t.child)return!1;if(!t.child)return!0;if(t.skipTransitionOnSameViewId){var n=t.activeView.getAttribute("data-view"),r=t.child.getAttribute("data-view");return n!=r}}return!0}return!1}function p(e){for(var t=0,n=e.length,r=[];n>t;t++){var i=e[t].cloneNode(!0);r.push(i)}return r}function g(e){var t=p(e.parts),n=y.getParts(t,null,!0),r=y.getParts(e.child);for(var i in n)o(r[i]).replaceWith(n[i])}function h(t){var n,r,i=a.virtualElements.childNodes(t.parent);if(!e.isArray(i)){var o=[];for(n=0,r=i.length;r>n;n++)o[n]=i[n];i=o}for(n=1,r=i.length;r>n;n++)a.removeNode(i[n])}function v(e){a.utils.domData.set(e,S,e.style.display),e.style.display="none"}function m(e){e.style.display=a.utils.domData.get(e,S)}function b(e){var t=e.getAttribute("data-bind");if(!t)return!1;for(var n=0,r=D.length;r>n;n++)if(t.indexOf(D[n])>-1)return!0;return!1}var y,w={},_="data-active-view",k=[],x=0,C="durandal-composition-data",A="data-part",I=["model","view","transition","area","strategy","activationData"],S="durandal-visibility-data",D=["compose:"],R={complete:function(e){k.push(e)}};return y={composeBindings:D,convertTransitionToModuleId:function(e){return"transitions/"+e},defaultTransitionName:null,current:R,addBindingHandler:function(e,t,n){var r,i,o="composition-handler-"+e;t=t||a.bindingHandlers[e],n=n||function(){return void 0},i=a.bindingHandlers[e]={init:function(e,r,i,s,l){if(x>0){var c={trigger:a.observable(null)};y.current.complete(function(){t.init&&t.init(e,r,i,s,l),t.update&&(a.utils.domData.set(e,o,t),c.trigger("trigger"))}),a.utils.domData.set(e,o,c)}else a.utils.domData.set(e,o,t),t.init&&t.init(e,r,i,s,l);return n(e,r,i,s,l)},update:function(e,t,n,r,i){var s=a.utils.domData.get(e,o);return s.update?s.update(e,t,n,r,i):(s.trigger&&s.trigger(),void 0)}};for(r in t)"init"!==r&&"update"!==r&&(i[r]=t[r])},getParts:function(e,t,n){if(t=t||{},!e)return t;void 0===e.length&&(e=[e]);for(var r=0,i=e.length;i>r;r++){var o=e[r];if(o.getAttribute){if(!n&&b(o))continue;var a=o.getAttribute(A);a&&(t[a]=o),!n&&o.hasChildNodes()&&y.getParts(o.childNodes,t)}}return t},cloneNodes:p,finalize:function(t){if(void 0===t.transition&&(t.transition=this.defaultTransitionName),t.child||t.activeView)if(f(t)){var r=this.convertTransitionToModuleId(t.transition);e.acquire(r).then(function(e){t.transition=e,e(t).then(function(){if(t.cacheViews){if(t.activeView){var e=n.getBindingInstruction(t.activeView);e&&void 0!=e.cacheViews&&!e.cacheViews&&a.removeNode(t.activeView)}}else t.child?h(t):a.virtualElements.emptyNode(t.parent);t.triggerAttach(),l(),c(t)})}).fail(function(t){e.error("Failed to load transition ("+r+"). Details: "+t.message)})}else{if(t.child!=t.activeView){if(t.cacheViews&&t.activeView){var i=n.getBindingInstruction(t.activeView);!i||void 0!=i.cacheViews&&!i.cacheViews?a.removeNode(t.activeView):v(t.activeView)}t.child?(t.cacheViews||h(t),m(t.child)):t.cacheViews||a.virtualElements.emptyNode(t.parent)}t.triggerAttach(),l(),c(t)}else t.cacheViews||a.virtualElements.emptyNode(t.parent),t.triggerAttach(),l(),c(t)},bindAndShow:function(e,t,i){t.child=e,t.composingNewView=t.cacheViews?-1==a.utils.arrayIndexOf(t.viewElements,e):!0,u(t,function(){if(t.binding&&t.binding(t.child,t.parent,t),t.preserveContext&&t.bindingContext)t.composingNewView&&(t.parts&&g(t),v(e),a.virtualElements.prepend(t.parent,e),n.bindContext(t.bindingContext,e,t.model));else if(e){var i=t.model||w,o=a.dataFor(e);if(o!=i){if(!t.composingNewView)return a.removeNode(e),r.createView(e.getAttribute("data-view")).then(function(e){y.bindAndShow(e,t,!0)}),void 0;t.parts&&g(t),v(e),a.virtualElements.prepend(t.parent,e),n.bind(i,e)}}y.finalize(t)},i)},defaultStrategy:function(e){return t.locateViewForObject(e.model,e.area,e.viewElements)},getSettings:function(t){var n,o=t(),s=a.utils.unwrapObservable(o)||{},l=i.isActivator(o);if(e.isString(s))return s=r.isViewUrl(s)?{view:s}:{model:s,activate:!0};if(n=e.getModuleId(s))return s={model:s,activate:!0};!l&&s.model&&(l=i.isActivator(s.model));for(var c in s)s[c]=-1!=a.utils.arrayIndexOf(I,c)?a.utils.unwrapObservable(s[c]):s[c];return l?s.activate=!1:void 0===s.activate&&(s.activate=!0),s},executeStrategy:function(e){e.strategy(e).then(function(t){y.bindAndShow(t,e)})},inject:function(n){return n.model?n.view?(t.locateView(n.view,n.area,n.viewElements).then(function(e){y.bindAndShow(e,n)}),void 0):(n.strategy||(n.strategy=this.defaultStrategy),e.isString(n.strategy)?e.acquire(n.strategy).then(function(e){n.strategy=e,y.executeStrategy(n)}).fail(function(t){e.error("Failed to load view strategy ("+n.strategy+"). Details: "+t.message)}):this.executeStrategy(n),void 0):(this.bindAndShow(null,n),void 0)},compose:function(n,r,i,o){x++,o||(r=y.getSettings(function(){return r},n)),r.compositionComplete&&k.push(function(){r.compositionComplete(r.child,r.parent,r)}),k.push(function(){r.composingNewView&&r.model&&r.model.compositionComplete&&r.model.compositionComplete(r.child,r.parent,r)});var a=s(n);r.activeView=a.activeView,r.parent=n,r.triggerAttach=d,r.bindingContext=i,r.cacheViews&&!r.viewElements&&(r.viewElements=a.childElements),r.model?e.isString(r.model)?e.acquire(r.model).then(function(t){r.model=e.resolveObject(t),y.inject(r)}).fail(function(t){e.error("Failed to load composed module ("+r.model+"). Details: "+t.message)}):y.inject(r):r.view?(r.area=r.area||"partial",r.preserveContext=!0,t.locateView(r.view,r.area,r.viewElements).then(function(e){y.bindAndShow(e,r)})):this.bindAndShow(null,r)}},a.bindingHandlers.compose={init:function(){return{controlsDescendantBindings:!0}},update:function(e,t,n,i,o){var s=y.getSettings(t,e);if(s.mode){var l=a.utils.domData.get(e,C);if(!l){var c=a.virtualElements.childNodes(e);l={},"inline"===s.mode?l.view=r.ensureSingleElement(c):"templated"===s.mode&&(l.parts=p(c)),a.virtualElements.emptyNode(e),a.utils.domData.set(e,C,l)}"inline"===s.mode?s.view=l.view.cloneNode(!0):"templated"===s.mode&&(s.parts=l.parts),s.preserveContext=!0}y.compose(e,s,o,!0)}},a.virtualElements.allowedBindings.compose=!0,y});